<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Помощник доктора на Hate RP (ок. 1900) — крафт и памятка</title>
<meta name="description" content="Витрина крафтов доктора с калькулятором материалов, прайс и подробная историческая памятка (около 1900 года) для RP на Hate RP.">
<style>
  /* ===== светлая, читаемая тема ===== */
  :root{
    color-scheme: light;
    --bg:#f7f8fb;
    --paper:#ffffff;
    --ink:#1f2328;
    --muted:#6a717a;
    --line:#e6e9ef;
    --accent:#0a7cff;
    --accent-2:#1f60ff;
    --danger:#b3261e;
    --ok:#1a7f5a;
    --radius:14px;
    --radius-sm:10px;
    --shadow:0 10px 30px rgba(0,0,0,.06);
    --font: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    --input-bg:#ffffff;
  }
  /* ===== тёмная тема — только переопределение переменных ===== */
  :root[data-theme="dark"]{
    color-scheme: dark;
    --bg:#0f1115;
    --paper:#12151b;
    --ink:#e7ecf3;
    --muted:#9aa3ad;
    --line:#1f2430;
    --accent:#5aa2ff;
    --accent-2:#7db6ff;
    --danger:#ff6b5f;
    --ok:#3cb179;
    --input-bg:#181c24;
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.65 var(--font);-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 200deg,#9ec2ff,#0a7cff 45%,#d7e5ff 85%,#9ec2ff);box-shadow:var(--shadow)}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:13px}

  /* Табы */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 18px}
  .tab{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:transparent;color:inherit;cursor:pointer}
  .tab[aria-selected="true"]{background:var(--accent);color:#fff;border-color:var(--accent)}

  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:var(--radius-sm);background:var(--input-bg);color:var(--ink);font:inherit;outline:none}
  select,option{color:var(--ink);background:var(--input-bg)}
  input:focus,select:focus{box-shadow:0 0 0 3px rgba(10,124,255,.18);border-color:var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);vertical-align:top}
  th{font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:var(--muted)}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family:var(--mono)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid var(--accent);background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent)}
  .btn.danger{background:var(--danger);border-color:var(--danger)}
  .btn.ok{background:var(--ok);border-color:var(--ok)}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 12px}
  .section-title{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0}
  .space{height:10px}
  .hr{height:1px;background:var(--line);margin:8px 0}
  .toc a{color:inherit;text-decoration:none}

  /* ===== плитки крафтов ===== */
  .tiles{
    display:grid;
    grid-template-columns: repeat( auto-fill, minmax(280px, 1fr) );
    gap:16px;
    margin-top:8px;
  }
  .tile{
    background:var(--paper);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .tile h4{ margin:0; font-size:16px; }
  .meta{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{ border:1px solid var(--line); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--muted) }
  .ing{ margin:0; padding-left:16px; }
  .ing li{ margin:0 0 4px 0; }
  .qtybar{ display:flex; gap:8px; align-items:center; }
  .qtybar input{ max-width:90px; text-align:right }
  .qtybar .btn.ghost{ min-width:42px }

  /* памятка — небольшие улучшения читаемости */
  #aidContent h4{ margin-top:18px }
  #aidContent h5{ margin-top:12px }
  #aidContent ul{ margin:6px 0 10px 20px }
  #aidContent ol{ margin:6px 0 10px 20px }
  #aidContent li + li{ margin-top:4px }
  mark{ background: #fff2a8; color: inherit; padding: 0 3px; border-radius: 3px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Помощник доктора (Hate RP · ок. 1900)</h1>
        <div class="sub">Витрина крафтов · Калькулятор материалов · Прейскурант · Большая историческая памятка</div>
      </div>
    </div>
    <button id="toggleTheme" class="tab" aria-pressed="false" style="border:1px solid var(--line);" aria-label="Переключить тему">Тема</button>
  </header>

  <nav class="tabs" role="tablist" aria-label="Разделы">
    <button class="tab" id="tab-calc" role="tab" aria-controls="calc" aria-selected="true" tabindex="0">Крафты</button>
    <button class="tab" id="tab-prices" role="tab" aria-controls="prices" aria-selected="false" tabindex="-1">Цены</button>
    <button class="tab" id="tab-aid" role="tab" aria-controls="aid" aria-selected="false" tabindex="-1">Памятка (1900)</button>
  </nav>

  <!-- ====================== КАЛЬКУЛЯТОР (ПЛИТКИ) ====================== -->
  <section id="calc" class="card" role="tabpanel" aria-labelledby="tab-calc">
    <div class="section-title">
      <h3 style="margin:0">Крафты доктора</h3>
      <div class="toolbar" style="gap:12px; flex-wrap:wrap">
        <input id="craftSearch" type="text" placeholder="Поиск: мазь, опиум, яд…" style="max-width:260px">
        <label class="pill small" title="Разложить вложенные изделия до сырья (например, «Аптечка» → Опиум → Мак и т.д.)">
          <input id="expandToRaw" type="checkbox" checked> Разворачивать до сырья
        </label>
        <span class="small muted">Задайте план на плитках — итоговые материалы посчитаются ниже.</span>
      </div>
    </div>

    <div id="tiles" class="tiles" aria-live="polite"></div>

    <div class="hr"></div>

    <div class="section-title">
      <h3 style="margin:0">Итог по материалам</h3>
      <span class="small muted">Суммируется по всем выбранным крафтам</span>
    </div>
    <table id="materialsTable" aria-live="polite">
      <thead>
        <tr>
          <th scope="col">Ингредиент</th>
          <th scope="col" class="right">Кол-во</th>
          <th scope="col">Ед.</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="3" class="small muted">Нет выбранных крафтов — добавьте план на плитках выше.</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ====================== ЦЕНЫ ====================== -->
  <section id="prices" class="card" role="tabpanel" aria-labelledby="tab-prices" hidden>
    <h3 style="margin:4px 0 12px">Стоимость услуг</h3>
    <table>
      <thead><tr><th scope="col">Услуга</th><th scope="col" class="right">Цена</th></tr></thead>
      <tbody id="services"></tbody>
    </table>

    <div class="hr"></div>

    <h3 style="margin:12px 0">Продажи</h3>
    <table>
      <thead><tr><th scope="col">Товар</th><th scope="col" class="right">Цена</th><th scope="col">Примечание</th></tr></thead>
      <tbody id="goods"></tbody>
    </table>

    <div class="hr"></div>

    <h3 style="margin:12px 0">Калькулятор оплаты</h3>
    <div class="toolbar">
      <select id="payItem" aria-label="Позиция для чека"></select>
      <input id="payQty" type="number" min="1" step="1" value="1" style="max-width:120px" aria-label="Количество">
      <button id="payAdd" class="btn">Добавить</button>
      <button id="payClear" class="btn danger">Очистить чек</button>
    </div>
    <p class="small muted">Скидки за опт применяются автоматически (например, ≥10 шт для бинтов, настоек и тоника). Суммируется по позиции.</p>

    <table id="payTable" style="margin-top:8px">
      <thead>
        <tr>
          <th scope="col">Позиция</th>
          <th scope="col" class="right">Кол-во</th>
          <th scope="col" class="right">Цена за ед.</th>
          <th scope="col" class="right">Скидка</th>
          <th scope="col" class="right">Итого</th>
          <th scope="col" class="right">Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="right">Итого к оплате:</th>
          <th class="right mono" id="payTotal" aria-live="polite">$0.00</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- ====================== ПАМЯТКА (БОЛЬШАЯ) ====================== -->
  <section id="aid" class="card" role="tabpanel" aria-labelledby="tab-aid" hidden>
    <div class="section-title">
      <h3 style="margin:0">Памятка врача (около 1900) — расширенная</h3>
      <input id="aidSearch" type="text" placeholder="Поиск: переломы, пулевые, эфир, сепсис…" style="max-width:360px" aria-label="Поиск по памятке">
    </div>
    <p class="small muted">Историзированные практики эпохи конца XIX — начала XX века (эпоха Листера: антисептика, кипячение, эфир/хлороформ, опиаты). Антибиотиков нет. Для RP на сервере — <b>не руководство</b> по реальной медицине.</p>

    <article id="aidContent">
      <h4>1) Контекст и рамки эпохи</h4>
      <ul>
        <li><b>Антисептика</b> уже известна: карболовая кислота (фенол), борная вода, спирт, йодоформ, кипячение инструментов.</li>
        <li><b>Анестезия</b>: эфир и хлороформ — в больнице/под наблюдением; местно — кокаиновые аппликации; опиаты (лауданум, морфин) — для обезболивания, высокий риск угнетения дыхания и зависимости.</li>
        <li><b>Антибиотиков нет</b>. Борьба с инфекцией — чистота, дренаж, открытое ведение грязных ран, частые перевязки.</li>
        <li><b>Перевязочные материалы</b>: стерильная марля, бинты, йодоформная марля, карболовые растворы, салол, карболизированные нити.</li>
        <li><b>Хирургические нити</b>: кетгут (рассасывающийся), шёлк; иглодержатели, шовный материал стерилизуют.</li>
      </ul>

      <h4>2) Инструменты и оснащение «полевого» доктора</h4>
      <ul>
        <li><b>Основное</b>: скальпель, ножницы, пинцеты (анатомический/хирургический), кровоостанавливающие зажимы (Кохера/Пеана), иглодержатель, иглы, зонды.</li>
        <li><b>Костная хирургия</b>: костные щипцы, распатор, долота, пилы (для ампутаций — редко), шины (деревянные/проволочные), бинты для иммобилизации.</li>
        <li><b>Ассистирующее</b>: жгуты, резиновые/тканевые дренажи, шприцы, бутылочки со спиртом/фенолом/борной водой, стерильные салфетки, лампы/клеёнка.</li>
        <li><b>Стерилизация</b>: кипячение 15–20 минут; обжиг; хранение в чистых боксах; промывка спиртом; руки — мыло, щётка, затем спирт/карболка.</li>
        <li><b>Анестезия</b>: маска для эфира/хлороформа; пульс/дыхание под наблюдением; местные аппликации кокаина; опиаты внутрь/подкожно (в лоре).</li>
      </ul>

      <h4>3) Базовые принципы ведения ран</h4>
      <ul>
        <li><b>Гемостаз</b>: давящая повязка; при артериальном кровотечении — жгут <i>выше</i> раны, отметить время; сосудистые зажимы/лигатуры при доступности.</li>
        <li><b>Антисептика кожи</b>: тёплая кипячёная вода/солевой раствор → спирт/борная вода/карболка; волосы вокруг раны срезать.</li>
        <li><b>Ревизия</b>: щадящая, без «ковыряния»; инородные тела извлекать, если доступны; нежизнеспособные ткани иссечь.</li>
        <li><b>Дренаж</b>: в грязных/рваных/огнестрельных ранах — дренажи, не закрывать герметично; ежедневные перевязки.</li>
        <li><b>Швы</b>: чистые резаные — первичный шов (шёлк/кетгут); загрязнённые — отсроченное закрытие.</li>
        <li><b>Иммобилизация</b> при травмах конечностей; покой, тепло, сладкий чай при риске шока.</li>
      </ul>

      <h4>4) Кровотечения</h4>
      <h5>Артериальное (алая пульсирующая струя)</h5>
      <ol>
        <li>Давящая повязка, конечность выше.</li>
        <li>Жгут выше раны; записать время наложения; ослаблять по возможности.</li>
        <li>При доступе — зажим и лигатура сосуда; при невозможности — тампонада и срочная эвакуация.</li>
      </ol>
      <h5>Венозное (тёмная, равномерная)</h5>
      <ol>
        <li>Давящая повязка, возвышение конечности.</li>
        <li>Непрерывное давление 10–15 минут; не подглядывать.</li>
      </ol>
      <h5>Носовое</h5>
      <ul>
        <li>Посадить, наклон вперёд; холод к переносице; прижимать крылья 10 минут.</li>
        <li>Упорное — турунды с борной водой/квасцами.</li>
      </ul>

      <h4>5) Пулевые ранения</h4>
      <ul>
        <li><b>Грязные по определению</b>. Опасны инфекция и шок, не «пуля как таковая».</li>
        <li>Оценить вход/выход; остановить кровотечение; умеренное обезболивание опиатами.</li>
        <li>Антисептика: промывки кипячёной/солевой водой; кожа — спирт/фенол.</li>
        <li>Зондирование минимально; поверхностные пули извлекают, глубокие без показаний — не трогают.</li>
        <li>При загрязнении/размозжении: расширить, некрэктомия, дренаж; не закрывать плотно; йодоформная марля.</li>
        <li>Иммобилизация при подозрении на перелом; наблюдение за признаками инфекции (жар, покраснение, лимфангит).</li>
      </ul>

      <h4>6) Ножевые/колотые/резаные</h4>
      <ul>
        <li><b>Инородный предмет не удалять на месте</b> — зафиксировать бинтами вокруг.</li>
        <li>Гемостаз; промывки; чистые резаные можно ушить первично; колотые/грязные — дренаж, отсроченный шов.</li>
        <li>Ранения живота/грудной клетки — ничего внутрь не вливать, транспортировка в стационар.</li>
      </ul>

      <h4>7) Переломы, вывихи, растяжения</h4>
      <h5>Переломы</h5>
      <ol>
        <li>Иммобилизация шинами (доски/ветви/проволочные шины), фиксировать два ближайших сустава.</li>
        <li>Открытые — антисептика, стерильная повязка, затем шина; при сильном смещении — осторожная тракция.</li>
        <li>Бедро/таз — осторожная транспортная тяга, при возможности — шина Дитерихса (в лоре — упрощённые аналоги).</li>
      </ol>
      <h5>Вывихи</h5>
      <ul>
        <li>Холод, обезболивание, иммобилизация.</li>
        <li>Вправление — опытным лицом; после — косыночная/пращевидная повязка, покой.</li>
      </ul>
      <h5>Растяжения</h5>
      <ul>
        <li>Покой, холод первые сутки → затем сухое тепло; повязка/бинт, возвышение.</li>
      </ul>

      <h4>8) ЧМТ и травма шеи/спины</h4>
      <ul>
        <li><b>Тревожные признаки</b>: потеря сознания, многократная рвота, судороги, неравные зрачки, вытекание крови/ликвора из носа/уха.</li>
        <li>Покой в тёмной комнате, голова приподнята; холод на голову; опиаты крайне осторожно.</li>
        <li>Раны кожи головы — швы после антисептики; ежедневные перевязки.</li>
        <li>Подозрение на повреждение позвоночника — жёсткая доска, минимум движений, воротник-импровизация.</li>
      </ul>

      <h4>9) Грудная клетка и живот</h4>
      <h5>Проникающее в грудь</h5>
      <ul>
        <li>Герметичная (окклюзионная) повязка: марля, сверху ткань, смазанная жиром/маслом; положение полусидя.</li>
        <li>Наблюдение за дыханием; боль — умеренно гасить; транспортировка.</li>
      </ul>
      <h5>Живот</h5>
      <ul>
        <li>Ничего внутрь; холод на живот; срочная эвакуация в больницу; вероятность перитонита высока.</li>
      </ul>

      <h4>10) Ожоги</h4>
      <ul>
        <li>1–2 степень — охлаждение чистой прохладной водой; пузыри не вскрывать.</li>
        <li>Повязки: стерильная марля; исторично — «карроновое масло» (известковая вода + льняное масло) или сухая повязка.</li>
        <li>Обширные — риск шока и инфекции: согреть, сладкий чай, чистые частые перевязки.</li>
      </ul>

      <h4>11) Инфекции и гнойные процессы (без антибиотиков)</h4>
      <ul>
        <li><b>Дренирование</b> — основа: рассечь и обеспечить отток гноя; полости тампонируют йодоформной марлей.</li>
        <li>Промывания тёплой кипячёной/солевой водой, борной водой, слабой карболкой.</li>
        <li>Столбняк: профилактики почти нет — тщательная хирургическая обработка ран, особенно загрязнённых почвой.</li>
      </ul>

      <h4>12) Обезболивание и анестезия</h4>
      <ul>
        <li><b>Опиаты</b> (лауданум/морфин/героин): снимают боль, угнетают дыхание; риск зависимости; дозы малые, наблюдение за дыханием.</li>
        <li><b>Местная анестезия</b>: кокаиновые аппликации/инфильтрации на небольших участках (опасность токсичности).</li>
        <li><b>Общий наркоз</b>: эфир/хлороформ — в «операционной» под присмотром ассистента: пульс, дыхание, цвет кожи; подготовка поля — карболка/спирт, чистое бельё, кипячёные инструменты.</li>
      </ul>

      <h4>13) Наркозависимости и абстиненция</h4>
      <ul>
        <li><b>Опиоидная зависимость</b> в эпохе встречается; специфических антагонистов нет.</li>
        <li>Симптомы передоза: сонливость, миоз, редкое/поверхностное дыхание. Поддерживающие меры: проходимость дыхательных путей, стимуляция (нашатырь), холодные обтирания, крепкий кофе/чай, согревание.</li>
        <li><b>Отмена</b>: раздражительность, боли, потливость, бессонница; поддержка — покой, жидкости, отвары; в лоре — «детокс» как выдуманная сыворотка.</li>
      </ul>

      <h4>14) Отравления, укусы</h4>
      <ul>
        <li><b>Алкоголь/травяные</b>: покой, промывание желудка (если недавно), поить водой/чаем, наблюдение.</li>
        <li><b>Змеиный укус</b>: покой, иммобилизация, мягкая лигатура выше укуса (не жгут), местная антисептика; в лоре — «противоядие»/сыворотка при наличии.</li>
      </ul>

      <h4>15) Удары/размозжение/падения</h4>
      <ul>
        <li>Оценка внутренних кровотечений: бледность, холодный пот, слабый пульс, жажда; покой, тепло, возвышенное положение ног.</li>
        <li>Мягкие ткани: холод 12–24 часа → сухое тепло.</li>
        <li>Рёбра: тугая повязка на выдохе; боли — по возможности минимально.</li>
      </ul>

      <h4>16) Организация «операции» в лоре</h4>
      <ol>
        <li>Асептика: руки — мыло+щётка → спирт/карболка; инструменты — кипячение 15–20 мин; чистые простыни.</li>
        <li>Анестезия: эфир/хлороформ; ассистент следит за дыханием/пульсом.</li>
        <li>Оперативный этап: гемостаз зажимами/лигатурами; иссечение мёртвых тканей; дренаж.</li>
        <li>Закрытие: шов при чистом поле; грязные — отсроченное закрытие; ежедневные перевязки.</li>
      </ol>

      <h4>17) Атмосферные детали RP</h4>
      <ul>
        <li>«Пахнет карболкой», «кипятит щипцы», «жгут наложен, время: 12:20».</li>
        <li>«Йодоформной пылью припудрил полость», «дренаж оставлен», «повязка сухая, чистая».</li>
        <li>Реакция на опиаты: «замедлился, стихла боль, лицо порозовело»; передоз — «дыхание редкое, зрачки булавочные».</li>
      </ul>
    </article>
  </section>

  <footer class="small muted" style="margin:18px 0">© Материалы — только для RP на Hate RP (RDR2). Не используйте для реальной медицины.</footer>
</div>

<script>
/* -------------------- УТИЛИТЫ -------------------- */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => (Math.round((n + Number.EPSILON)*100)/100).toString().replace(".",",");

/* Нормализация имён для сопоставления (ё→е, подчистка опечаток «парацет[о|а]мол», «чёрная/черная» и т.п.) */
function normName(s){
  const x = String(s||"").toLowerCase().replace(/ё/g,"е").trim();
  return x
    .replace(/\bпарацетомол\b/g,"парацетамол")
    .replace(/\bчёрная смородина\b/g,"черная смородина");
}

/* -------------------- ТАБЫ с улучшенной доступностью -------------------- */
(function(){
  const order = ["tab-calc","tab-prices","tab-aid"];
  const map = {"tab-calc":"calc","tab-prices":"prices","tab-aid":"aid"};
  function activate(id){
    order.forEach(k=>{
      const btn = $("#"+k);
      const panel = $("#"+map[k]);
      const active = (k===id);
      btn.setAttribute("aria-selected", active ? "true" : "false");
      btn.setAttribute("tabindex", active ? "0" : "-1");
      panel.hidden = !active;
    });
  }
  order.forEach(id=>{
    const btn = $("#"+id);
    btn.addEventListener("click", ()=>{ activate(id); btn.focus(); });
  });
  // клавиатура: стрелки/дом/энд
  $(".tabs").addEventListener("keydown", e=>{
    const tabs = order.map(id=>$("#"+id));
    const idx = tabs.indexOf(document.activeElement);
    if(idx<0) return;
    let n = idx;
    if(e.key==="ArrowRight"){ e.preventDefault(); n=(idx+1)%tabs.length; tabs[n].click(); }
    if(e.key==="ArrowLeft"){ e.preventDefault(); n=(idx-1+tabs.length)%tabs.length; tabs[n].click(); }
    if(e.key==="Home"){ e.preventDefault(); tabs[0].click(); }
    if(e.key==="End"){ e.preventDefault(); tabs[tabs.length-1].click(); }
  });
})();

/* -------------------- Переключатель темы (с сохранением) -------------------- */
(function(){
  const KEY = "hrp_theme";
  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  const saved = localStorage.getItem(KEY);
  const start = saved || (prefersDark ? "dark" : "light");
  function apply(theme){
    document.documentElement.setAttribute("data-theme", theme);
    document.documentElement.style.colorScheme = (theme === "dark") ? "dark" : "light";
    localStorage.setItem(KEY, theme);
    const btn = document.getElementById("toggleTheme");
    if(btn) btn.setAttribute("aria-pressed", theme === "dark" ? "true" : "false");
  }
  apply(start);
  const btn = document.getElementById("toggleTheme");
  if(btn){
    btn.addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
      apply(cur === "dark" ? "light" : "dark");
    });
  }
})();

/* -------------------- ДАННЫЕ: витрина докторских крафтов -------------------- */
/* Делаем точное соответствие вашему списку (время в секундах). */
const DOCTOR_CRAFTS = [
  {id:"paracetamol", name:"Парацетомол", output:1, stack:10, timeSec:120, ing:[
    {name:"Яд",qty:1,unit:"шт"},{name:"Стеклянная бутылка",qty:1,unit:"шт"},
    {name:"Соль",qty:1,unit:"шт"},{name:"Агава",qty:2,unit:"шт"}]},
  {id:"bint-steril", name:"Бинт стерильный", output:2, stack:20, timeSec:120, ing:[
    {name:"Волокна древесные",qty:1,unit:"шт"},{name:"Спирт",qty:1,unit:"шт"},{name:"Алоэ",qty:2,unit:"шт"}]},
  {id:"maz-lechebnaya", name:"Лечебная мазь", output:1, stack:10, timeSec:120, ing:[
    {name:"Животный жир",qty:1,unit:"шт"},{name:"Алоэ",qty:3,unit:"шт"},
    {name:"Змеиный яд",qty:1,unit:"шт"},{name:"Тысячелистник",qty:2,unit:"шт"}]},
  {id:"aptechka-heroine", name:"Аптечка на героине", output:1, stack:10, timeSec:120, ing:[
    {name:"Героин",qty:1,unit:"шт"},{name:"Противоядие",qty:1,unit:"шт"},{name:"Бинт стерильный",qty:1,unit:"шт"}]},
  {id:"protivoyadie", name:"Противоядие", output:1, stack:10, timeSec:120, ing:[
    {name:"Зимняя ягода",qty:1,unit:"шт"},{name:"Змеиный яд",qty:1,unit:"шт"},{name:"Чок Дейзи",qty:1,unit:"шт"}]},
  {id:"hirurg-nabor", name:"Хирургический набор", output:1, stack:10, timeSec:60, ing:[
    {name:"Змеиный яд",qty:1,unit:"шт"},{name:"Вода",qty:1,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"},{name:"Бинт простой",qty:1,unit:"шт"},{name:"Опиум",qty:1,unit:"шт"}]},
  {id:"otvar-travy", name:"Отвар на травах", output:1, stack:15, timeSec:120, ing:[
    {name:"Английская булава",qty:2,unit:"шт"},{name:"Ползучий тимьян",qty:2,unit:"шт"},
    {name:"Гриб-зонтик",qty:2,unit:"шт"},{name:"Алоэ",qty:2,unit:"шт"}]},
  {id:"nast-zheludok", name:'Настойка "Здоровый желудок"', output:1, stack:15, timeSec:20, ing:[
    {name:"Прерийный мак",qty:2,unit:"шт"},{name:"Алоэ",qty:2,unit:"шт"},
    {name:"Аляскинский женьшень",qty:1,unit:"шт"},{name:"Тысячелистник",qty:2,unit:"шт"}]},
  {id:"tonik-hinin", name:"Тоник с Хинином", output:2, stack:15, timeSec:120, ing:[
    {name:"Стеклянная бутылка",qty:1,unit:"шт"},{name:"Спирт",qty:1,unit:"шт"},
    {name:"Мягкая древесина",qty:3,unit:"шт"},{name:"Алоэ",qty:3,unit:"шт"}]},
  {id:"maz-salic", name:"Салициловая мазь", output:1, stack:10, timeSec:140, ing:[
    {name:"Животный жир",qty:1,unit:"шт"},{name:"Шалфей олеандровый",qty:3,unit:"шт"},{name:"Мягкая древесина",qty:2,unit:"шт"}]},
  {id:"nast-uspokaiv", name:"Успокаивающая настойка", output:1, stack:15, timeSec:20, ing:[
    {name:"Спирт",qty:1,unit:"шт"},{name:"Американский женьшень",qty:1,unit:"шт"},
    {name:"Алоэ",qty:2,unit:"шт"},{name:"Дикая мята",qty:2,unit:"шт"}]},
  {id:"bint-prost", name:"Бинт простой", output:1, stack:20, timeSec:40, ing:[
    {name:"Волокна древесные",qty:1,unit:"шт"},{name:"Вода",qty:1,unit:"шт"},
    {name:"Мёд",qty:1,unit:"шт"},{name:"Алоэ",qty:2,unit:"шт"}]},
  {id:"geroin", name:"Героин", output:2, stack:10, timeSec:120, ing:[
    {name:"Яд",qty:2,unit:"шт"},{name:"Красная малина",qty:4,unit:"шт"},{name:"Морфин",qty:2,unit:"шт"}]},
  {id:"yad", name:"Яд", output:2, stack:20, timeSec:45, ing:[
    {name:"Прерийный мак",qty:5,unit:"шт"},{name:"Змеиный яд",qty:1,unit:"шт"},{name:"Нитрит",qty:4,unit:"шт"}]},
  {id:"laudanum", name:"Лауданум", output:1, stack:10, timeSec:120, ing:[
    {name:"Опиум",qty:2,unit:"шт"},{name:"Спирт",qty:1,unit:"шт"},{name:"Змеиный яд",qty:2,unit:"шт"},{name:"Алоэ",qty:3,unit:"шт"}]},
  {id:"opium", name:"Опиум", output:1, stack:10, timeSec:120, ing:[
    {name:"Прерийный мак",qty:3,unit:"шт"},{name:"Яд",qty:2,unit:"шт"},{name:"Стеклянная бутылка",qty:1,unit:"шт"}]},
  {id:"detox", name:"Детокс", output:1, stack:10, timeSec:120, ing:[
    {name:"Молочай",qty:2,unit:"шт"},{name:"Кровавый цветок",qty:5,unit:"шт"},{name:"Змеиный яд",qty:1,unit:"шт"},
    {name:"Вода",qty:1,unit:"шт"},{name:"Парацетамол",qty:2,unit:"шт"},{name:"Спирт",qty:3,unit:"шт"},
    {name:"Шалфей олеандровый",qty:3,unit:"шт"},{name:"Опиум",qty:2,unit:"шт"}]},
  {id:"nast-kosti", name:'Настойка "Крепкие кости"', output:1, stack:15, timeSec:20, ing:[
    {name:"Прерийный мак",qty:2,unit:"шт"},{name:"Животный жир",qty:1,unit:"шт"},{name:"Тысячелистник",qty:2,unit:"шт"}]},
  {id:"tonik-toniz", name:"Тонизирующий тоник", output:2, stack:15, timeSec:120, ing:[
    {name:"Сахар",qty:2,unit:"шт"},{name:"Черная смородина",qty:3,unit:"шт"},{name:"Стеклянная бутылка",qty:1,unit:"шт"},
    {name:"Агава",qty:2,unit:"шт"},{name:"Аляскинский женьшень",qty:2,unit:"шт"},{name:"Дикая мята",qty:1,unit:"шт"}]},
  {id:"aptechka-opium", name:"Аптечка на опиуме", output:1, stack:10, timeSec:120, ing:[
    {name:"Опиум",qty:1,unit:"шт"},{name:"Противоядие",qty:1,unit:"шт"},{name:"Бинт стерильный",qty:1,unit:"шт"}]},
  {id:"morfin", name:"Морфин", output:1, stack:10, timeSec:120, ing:[
    {name:"Прерийный мак",qty:2,unit:"шт"},{name:"Спирт",qty:1,unit:"шт"},{name:"Стеклянная бутылка",qty:1,unit:"шт"}]},
  {id:"syrop-dr-kaf", name:'Сироп "Др. Каф"', output:1, stack:15, timeSec:55, ing:[
    {name:"Листья коки",qty:4,unit:"шт"},{name:"Спирт",qty:1,unit:"шт"},{name:"Нитрит",qty:1,unit:"шт"},
    {name:"Сахар",qty:4,unit:"шт"},{name:"Вода",qty:1,unit:"шт"}]},
];

/* Стоп-список для развёртки (как в старом калькуляторе) */
const DO_NOT_EXPAND = new Set(["yad","protivoyadie","bint-steril"]);

/* Поиск рецепта по названию (c нормализацией) и по id */
function craftByName(name){
  const n = normName(name);
  return DOCTOR_CRAFTS.find(c=>normName(c.name)===n) || null;
}
function craftById(id){ return DOCTOR_CRAFTS.find(c=>c.id===id) || null; }

/* Человеческий формат времени */
function fmtTime(sec){
  sec = Math.round(sec||0);
  const m = Math.floor(sec/60), s = sec%60;
  if(m && s) return `${m} мин ${s} с`;
  if(m) return `${m} мин`;
  return `${s} с`;
}

/* План крафтов: [{id, qty}] — сохраняем между сессиями */
let plan = [];
const PLAN_KEY = "hrp_doctor_plan_v2";

/* Развёртка до листьев (сырья) с защитой от циклов и учётом output */
function expandToLeavesById(recipeId, qty, expandRaw, visited=new Set()){
  const rec = craftById(recipeId); if(!rec) return [];
  const factor = qty / (rec.output || 1);
  const leaves = [];
  for(const ing of rec.ing){
    const sub = craftByName(ing.name);
    const canExpand = expandRaw && sub && !DO_NOT_EXPAND.has(sub.id) && !visited.has(sub.id);
    if(canExpand){
      visited.add(sub.id);
      const deeper = expandToLeavesById(sub.id, ing.qty * factor, expandRaw, visited);
      visited.delete(sub.id);
      leaves.push(...deeper);
    }else{
      leaves.push({name: ing.name, unit: ing.unit || "шт", qty: ing.qty * factor});
    }
  }
  return leaves;
}
function aggregateLeaves(leaves){
  const map = new Map();
  for(const x of leaves){
    const key = normName(x.name) + "|" + (x.unit||"");
    map.set(key, (map.get(key)||0) + x.qty);
  }
  return Array.from(map.entries()).map(([key,qty])=>{
    const [norm,unit] = key.split("|");
    const original = leaves.find(l=>normName(l.name)===norm)?.name || norm;
    const q = Math.round((qty + Number.EPSILON)*100)/100;
    return {name: original, unit, qty: q};
  }).sort((a,b)=> a.name.localeCompare(b.name, 'ru'));
}

/* Рендер плитки */
function tileHTML(craft, plannedQty){
  const totalOut = plannedQty * (craft.output||1);
  return `
    <article class="tile" data-id="${craft.id}">
      <div style="display:flex; justify-content:space-between; gap:8px; align-items:flex-start">
        <h4>${craft.name}</h4>
        <span class="chip" title="Макс. стак">${craft.stack ? ("стак "+craft.stack) : "—"}</span>
      </div>
      <div class="meta">
        <span class="chip" title="Выход за 1 крафт">выход: ×${craft.output}</span>
        <span class="chip" title="Время крафта">⏱ ${fmtTime(craft.timeSec)}</span>
        <span class="chip" title="Планируется крафтов">план: ×<span class="planN">${plannedQty}</span> → всего: <b class="totalOut">${totalOut}</b></span>
      </div>
      <div>
        <div class="small muted" style="margin-bottom:4px">Ингредиенты на 1 крафт:</div>
        <ul class="ing">
          ${craft.ing.map(i=>`<li>${i.name} — <b>${i.qty}</b> ${i.unit||"шт"}</li>`).join("")}
        </ul>
      </div>
      <div class="qtybar">
        <button class="btn ghost" data-act="dec" aria-label="Уменьшить">−</button>
        <input class="qty" type="number" min="0" step="1" value="${plannedQty}" aria-label="План крафтов">
        <button class="btn ghost" data-act="inc" aria-label="Увеличить">+</button>
        <button class="btn danger" data-act="clr" style="margin-left:auto">Сброс</button>
      </div>
    </article>
  `;
}

/* Рендер списка плиток (с поиском) */
function renderTiles(){
  const q = normName($("#craftSearch").value || "");
  const tiles = $("#tiles");
  const filtered = DOCTOR_CRAFTS
    .filter(c=> !q || normName(c.name).includes(q))
    .sort((a,b)=> a.name.localeCompare(b.name,'ru'));
  const qtyOf = id => (plan.find(x=>x.id===id)?.qty || 0);
  tiles.innerHTML = filtered.map(c=>tileHTML(c, qtyOf(c.id))).join("");

  tiles.querySelectorAll(".tile").forEach(tile=>{
    const id = tile.dataset.id;
    const inp = tile.querySelector("input.qty");
    const setQty = (n)=>{
      const qty = Math.max(0, Number.isFinite(+n)? Math.floor(+n) : 0);
      const i = plan.findIndex(x=>x.id===id);
      if(qty===0){ if(i>=0) plan.splice(i,1); }
      else { if(i>=0) plan[i].qty = qty; else plan.push({id, qty}); }
      tile.querySelector(".planN").textContent = qty;
      const craft = craftById(id);
      tile.querySelector(".totalOut").textContent = (qty * (craft.output||1));
      renderMaterials();
      persistPlan();
    };
    tile.addEventListener("click",(e)=>{
      const act = e.target?.dataset?.act;
      if(!act) return;
      e.preventDefault();
      const cur = Math.max(0, +inp.value||0);
      if(act==="inc") setQty(cur+1);
      if(act==="dec") setQty(Math.max(0,cur-1));
      if(act==="clr") setQty(0);
      inp.value = plan.find(x=>x.id===id)?.qty || 0;
    });
    inp.addEventListener("change", ()=> setQty(inp.value));
  });
}

/* Итоговые материалы */
function renderMaterials(){
  const expandRaw = $("#expandToRaw").checked;
  const leaves = [];
  for(const line of plan){
    leaves.push(...expandToLeavesById(line.id, line.qty, expandRaw, new Set([line.id])));
  }
  const totals = aggregateLeaves(leaves);
  const tb = $("#materialsTable tbody");
  if(totals.length===0){
    tb.innerHTML = `<tr><td colspan="3" class="small muted">Нет выбранных крафтов — добавьте план на плитках выше.</td></tr>`;
    return;
  }
  tb.innerHTML = totals.map(t=>`
    <tr>
      <td>${t.name}</td>
      <td class="right">${String(t.qty).replace(".", ",")}</td>
      <td>${t.unit}</td>
    </tr>`).join("");
}

/* Поиск, переключатели, восстановление */
function persistPlan(){ localStorage.setItem(PLAN_KEY, JSON.stringify(plan)); }
function restorePlan(){
  try{
    const raw = JSON.parse(localStorage.getItem(PLAN_KEY)||"[]");
    if(Array.isArray(raw)) plan = raw.filter(x=>craftById(x.id) && Number.isFinite(+x.qty) && +x.qty>0)
                                     .map(x=>({id:x.id, qty:Math.floor(+x.qty)}));
  }catch(e){ plan = []; }
}
function initDoctorTiles(){
  restorePlan();
  renderTiles();
  renderMaterials();
  $("#craftSearch").addEventListener("input", renderTiles);
  $("#expandToRaw").addEventListener("change", renderMaterials);
}
initDoctorTiles();

/* -------------------- ПРАЙС: таблицы и калькулятор оплаты -------------------- */
const SERVICES = [
  ["Осмотр", "$2"],
  ["Лечение аптечкой (реанимация)", "$15"],
  ["Лечение тяжёлой травмы (операция)", "$18"],
  ["Детокс", "$50"]
];
const GOODS = [
  ["Бинты (розница)", "$3.5 /шт; от 10 шт — $3 /шт", ""],
  ["Бинты (для полиции)", "$2.5 /шт; от 10 шт — $2 /шт", ""],
  ["Тонизирующий тоник", "$4.5 /шт; от 10 шт — $4 /шт", ""],
  ["Лечебная мазь", "$4 /шт", ""],
  ["Салициловая мазь", "$3 /шт", ""],
  ["Отвар на травах", "$3 /шт", ""],
  ["Противоядие", "$3 /шт", ""],
  ["Настойка «крепкие кости»", "$4 /шт; от 10 шт — $3.5 /шт", ""],
  ["Настойка «крепкий желудок»", "$4 /шт; от 10 шт — $3.5 /шт", "в крафтах: «Здоровый желудок»"],
  ["Успокаивающая настойка", "$4 /шт; от 10 шт — $3.5 /шт", ""]
];
(function(){
  $("#services").innerHTML = SERVICES.map(([n,p])=>`<tr><td>${n}</td><td class="right mono">${p}</td></tr>`).join("");
  $("#goods").innerHTML = GOODS.map(([n,p,note])=>`<tr><td>${n}</td><td class="right mono">${p}</td><td class="small muted">${note||""}</td></tr>`).join("");
})();

/* Чёткая модель цен — не парсим строки из таблиц */
const PRICING = [
  // Услуги
  {id:"svc_osmotr", name:"Осмотр", type:"service", price: 2},
  {id:"svc_reanim", name:"Лечение аптечкой (реанимация)", type:"service", price: 15},
  {id:"svc_oper",   name:"Лечение тяжёлой травмы (операция)", type:"service", price: 18},
  {id:"svc_detox",  name:"Детокс", type:"service", price: 50},
  // Товары (с оптом)
  {id:"g_bandage_retail", name:"Бинт (розница)", type:"good",
    pricing:{base:3.5, bulk:{threshold:10, price:3}}},
  {id:"g_bandage_police", name:"Бинт (для полиции)", type:"good",
    pricing:{base:2.5, bulk:{threshold:10, price:2}}},
  {id:"g_tonik_toniz", name:"Тонизирующий тоник", type:"good",
    pricing:{base:4.5, bulk:{threshold:10, price:4}}},
  {id:"g_maz_lechebnaya", name:"Лечебная мазь", type:"good",
    pricing:{base:4}},
  {id:"g_maz_salic", name:"Салициловая мазь", type:"good",
    pricing:{base:3}},
  {id:"g_otvar", name:"Отвар на травах", type:"good",
    pricing:{base:3}},
  {id:"g_antidote", name:"Противоядие", type:"good",
    pricing:{base:3}},
  {id:"g_nast_kosti", name:'Настойка «крепкие кости»', type:"good",
    pricing:{base:4, bulk:{threshold:10, price:3.5}}},
  {id:"g_nast_zheludok", name:'Настойка «крепкий желудок»', type:"good",
    pricing:{base:4, bulk:{threshold:10, price:3.5}}},
  {id:"g_nast_uspok", name:"Успокаивающая настойка", type:"good",
    pricing:{base:4, bulk:{threshold:10, price:3.5}}},
];
// селектор с группировкой
(function initPaySelect(){
  const sel = document.getElementById("payItem");
  const groups = {service: document.createElement("optgroup"), good: document.createElement("optgroup")};
  groups.service.label = "Услуги"; groups.good.label = "Товары";
  PRICING.forEach(p=>{
    const o = document.createElement("option");
    o.value = p.id; o.textContent = p.name;
    groups[p.type].appendChild(o);
  });
  sel.appendChild(groups.service);
  sel.appendChild(groups.good);
})();
const payCart = []; // [{id, qty}]
function formatMoney(n){ return "$" + n.toFixed(2); }
function findPriceItem(id){ return PRICING.find(p=>p.id===id); }
function unitPriceFor(item, qty){
  if(item.type === "service"){ return {unit: item.price, note: ""}; }
  const rule = item.pricing || {base:0};
  if(rule.bulk && qty >= rule.bulk.threshold){
    return {unit: rule.bulk.price, note: `опт ≥${rule.bulk.threshold}`};
  }
  return {unit: rule.base, note: ""};
}
function renderPay(){
  const tb = document.querySelector("#payTable tbody");
  let total = 0;
  tb.innerHTML = payCart.map((line, i)=>{
    const item = findPriceItem(line.id);
    const {unit, note} = unitPriceFor(item, line.qty);
    const sum = unit * line.qty; total += sum;
    return `<tr>
      <td>${item.name}</td>
      <td class="right">${line.qty}</td>
      <td class="right mono">${formatMoney(unit)}</td>
      <td class="right small muted">${note || "—"}</td>
      <td class="right mono">${formatMoney(sum)}</td>
      <td class="right">
        <button class="btn ghost" data-act="inc" data-i="${i}">+1</button>
        <button class="btn ghost" data-act="dec" data-i="${i}">−1</button>
        <button class="btn danger" data-act="del" data-i="${i}">Удалить</button>
      </td>
    </tr>`;
  }).join("");
  document.getElementById("payTotal").textContent = formatMoney(total);
  tb.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const i = +b.dataset.i, act = b.dataset.act;
      if(act==="inc") payCart[i].qty++;
      if(act==="dec") payCart[i].qty = Math.max(1, payCart[i].qty - 1);
      if(act==="del") payCart.splice(i,1);
      renderPay();
    });
  });
}
document.getElementById("payAdd").addEventListener("click", ()=>{
  const id = document.getElementById("payItem").value;
  const qty = Math.max(1, +document.getElementById("payQty").value || 1);
  const idx = payCart.findIndex(x=>x.id===id);
  if(idx>=0) payCart[idx].qty += qty; else payCart.push({id, qty});
  renderPay();
});
document.getElementById("payClear").addEventListener("click", ()=>{ payCart.length = 0; renderPay(); });
renderPay();

/* -------------------- Поиск по памятке -------------------- */
$("#aidSearch").addEventListener("input", ()=>{
  const q = normName($("#aidSearch").value);
  const secs = $("#aidContent").querySelectorAll("h4, h5, p, li");
  secs.forEach(el=>{
    const visible = !q || normName(el.textContent).includes(q);
    el.style.display = visible ? "" : "none";
    if(q && visible && el.nodeName!=="LI"){
      // простенькая подсветка совпадений в H4/H5/P
      el.innerHTML = el.textContent.replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),"gi"), m=>`<mark>${m}</mark>`);
    }else if(!q){
      el.innerHTML = el.textContent; // снять подсветку
    }
  });
});
</script>
</body>
</html>
