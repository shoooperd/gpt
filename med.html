<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Помощник доктора (ок. 1900) — крафты и цены</title>
<meta name="description" content="Калькулятор крафтов доктора и прейскурант для RP на Hate RP (RDR2). Единый стиль, тёмная тема.">
<style>
  /* ===== базовая тема ===== */
  :root{
    color-scheme: light;
    --bg:#f7f8fb; --paper:#ffffff; --ink:#1f2328; --muted:#6a717a;
    --line:#e6e9ef; --accent:#0a7cff; --accent-2:#1f60ff;
    --danger:#b3261e; --ok:#1a7f5a;
    --radius:14px; --radius-sm:10px; --shadow:0 10px 30px rgba(0,0,0,.06);
    --font: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    --input-bg:#ffffff;
  }
  /* ===== тёмная тема ===== */
  :root[data-theme="dark"]{
    color-scheme: dark;
    --bg:#0f1115; --paper:#12151b; --ink:#e7ecf3; --muted:#9aa3ad;
    --line:#1f2430; --accent:#5aa2ff; --accent-2:#7db6ff;
    --danger:#ff6b5f; --ok:#3cb179; --input-bg:#181c24;
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.65 var(--font);-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 200deg,#9ec2ff,#0a7cff 45%,#d7e5ff 85%,#9ec2ff);box-shadow:var(--shadow)}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:13px}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 18px}
  .tab, .btn-link{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:transparent;color:inherit;cursor:pointer;text-decoration:none;display:inline-block}
  .tab[aria-selected="true"]{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn{appearance:none;border:1px solid var(--accent);background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent)}
  .btn.danger{background:var(--danger);border-color:var(--danger)}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 12px}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:var(--radius-sm);background:var(--input-bg);color:var(--ink);font:inherit;outline:none}
  select,option{color:var(--ink);background:var(--input-bg)}
  input:focus,select:focus{box-shadow:0 0 0 3px rgba(10,124,255,.18);border-color:var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);vertical-align:top}
  th{font-size:12px;letter-spacing:.06em;text-transform:uppercase;color:var(--muted)}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family:var(--mono)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hr{height:1px;background:var(--line);margin:8px 0}

  /* плитки */
  .tiles{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:8px}
  .tile{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px}
  .tile h4{margin:0;font-size:16px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
  .ing{margin:0;padding-left:16px}
  .qtybar{display:flex;gap:8px;align-items:center}
  .qtybar input{max-width:90px;text-align:right}
  .subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .subtabs .tab{padding:8px 12px}
  .tree{display:flex;flex-direction:column;gap:12px}
  .tree .group{border:1px solid var(--line);border-radius:12px;padding:10px}
  .tree summary{cursor:pointer;user-select:none}
  .tree ul{margin:6px 0 0 18px}
  .badge{display:inline-block;border:1px solid var(--line);border-radius:8px;padding:2px 6px;font-size:12px;color:var(--muted);margin-left:6px}
  .badge.craft{border-color:var(--accent);color:var(--accent)}
  .badge.raw{border-color:var(--muted)}

  .two-cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:960px){.two-cols{grid-template-columns:1fr}}
  footer{margin:18px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Помощник доктора (ок. 1900) — крафт и цены</h1>
        <div class="sub">Материалы и порядок · Витрина крафтов · Калькулятор оплаты</div>
      </div>
    </div>
    <div class="toolbar">
      <a class="tab btn-link" href="med_info.html" title="Перейти к подробному справочнику">Справочник</a>
      <button id="toggleTheme" class="tab" aria-pressed="false" style="border:1px solid var(--line);" aria-label="Переключить тему">Тема</button>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Разделы">
    <button class="tab" id="tab-calc" role="tab" aria-controls="calc" aria-selected="true" tabindex="0">Крафты</button>
    <button class="tab" id="tab-prices" role="tab" aria-controls="prices" aria-selected="false" tabindex="-1">Цены</button>
  </nav>

  <!-- ====================== КАЛЬКУЛЯТОР ====================== -->
  <section id="calc" class="card" role="tabpanel" aria-labelledby="tab-calc">
    <div class="section-title">
      <h3 style="margin:0">Материалы и порядок</h3>
      <nav class="subtabs" role="tablist" aria-label="Вид итогов">
        <button class="tab" data-mode="tree" aria-selected="true">Дерево состава</button>
        <button class="tab" data-mode="totals" aria-selected="false">Итог по сырью</button>
        <button class="tab" data-mode="order" aria-selected="false">Порядок крафта</button>
      </nav>
    </div>

    <div class="two-cols">
      <div id="matTree" class="tree" aria-live="polite">
        <div class="small muted">Нет выбранных крафтов — добавьте план на плитках ниже.</div>
      </div>
      <div>
        <div id="totalsWrap">
          <table id="materialsTable" aria-live="polite">
            <thead>
              <tr><th>Ингредиент</th><th class="right">Кол-во</th><th>Ед.</th></tr>
            </thead>
            <tbody>
              <tr><td colspan="3" class="small muted">Нет выбранных крафтов — добавьте план на плитках ниже.</td></tr>
            </tbody>
          </table>
        </div>
        <div id="orderWrap" hidden>
          <table id="craftOrderTable" aria-live="polite">
            <thead>
              <tr><th class="right">Шаг</th><th>Рецепт</th><th class="right">Нужно предметов</th><th class="right">Выход</th><th class="right">Крафтов (≈)</th></tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="small muted">Нет зависимостей — выберите крафты и включите разворачивание при необходимости.</td></tr>
            </tbody>
          </table>
          <p class="small muted">Значение «Крафтов (≈)» — дробное, округляйте до целого по правилам сервера.</p>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="section-title">
      <h3 style="margin:0">Крафты доктора</h3>
      <div class="toolbar" style="gap:12px;flex-wrap:wrap">
        <input id="craftSearch" type="text" placeholder="Поиск: мазь, опиум, яд…" style="max-width:260px">
        <label class="pill small" title="Разворачивать все крафтовые ингредиенты в дерево до сырья">
          <input id="expandToRaw" type="checkbox" checked> Разворачивать до сырья
        </label>
        <button id="planClearAll" class="btn danger" title="Очистить все планы крафта">Очистить всё</button>
        <span class="small muted">Меняйте план на плитках — сводные таблицы обновятся сразу.</span>
      </div>
    </div>

    <div id="tiles" class="tiles" aria-live="polite"></div>
  </section>

  <!-- ====================== ЦЕНЫ ====================== -->
  <section id="prices" class="card" role="tabpanel" aria-labelledby="tab-prices" hidden>
    <h3 style="margin:4px 0 12px">Калькулятор оплаты</h3>
    <div class="toolbar">
      <select id="payItem" aria-label="Позиция для чека"></select>
      <input id="payQty" type="number" min="1" step="1" value="1" style="max-width:120px" aria-label="Количество">
      <button id="payAdd" class="btn">Добавить</button>
      <button id="payClear" class="btn danger">Очистить чек</button>
    </div>
    <table id="payTable" style="margin-top:8px">
      <thead>
        <tr>
          <th>Позиция</th><th class="right">Кол-во</th><th class="right">Цена за ед.</th><th class="right">Итого</th><th class="right">Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><th colspan="3" class="right">Итого к оплате:</th><th class="right mono" id="payTotal" aria-live="polite">$0.00</th><th></th></tr>
      </tfoot>
    </table>

    <div class="hr"></div>

    <h3 style="margin:12px 0">Стоимость услуг</h3>
    <table>
      <thead><tr><th>Услуга</th><th class="right">Цена</th></tr></thead>
      <tbody id="services"></tbody>
    </table>
    <div class="hr"></div>
    <h3 style="margin:12px 0">Продажи</h3>
    <table>
      <thead><tr><th>Товар</th><th class="right">Цена</th><th>Примечание</th></tr></thead>
      <tbody id="goods"></tbody>
    </table>
  </section>

  <footer class="small muted">
    © Для RP на Hate RP (RDR2). <b>Не руководство</b> по реальной медицине.
    <span style="float:right">
      <a class="btn-link" href="doctor_reference_1900.html" title="Подробный справочник">Открыть справочник →</a>
    </span>
  </footer>
</div>

<script>
/* -------------------- УТИЛИТЫ -------------------- */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => {
  const x = Math.round((Number(n)||0 + Number.EPSILON)*100)/100;
  return String(x).replace(".", ",");
};

/* Нормализация имён для сопоставления */
function normName(s){
  return String(s||"").toLowerCase().replace(/ё/g,"е").trim()
    .replace(/\bпарацетомол\b/g,"парацетамол")
    .replace(/\bчёрная смородина\b/g,"черная смородина");
}

/* -------------------- ТАБЫ (ARIA) -------------------- */
(function(){
  const order = ["tab-calc","tab-prices"];
  const map = {"tab-calc":"calc","tab-prices":"prices"};
  function activate(id){
    order.forEach(k=>{
      const btn = $("#"+k);
      const panel = $("#"+map[k]);
      const active = (k===id);
      btn.setAttribute("aria-selected", active ? "true" : "false");
      btn.setAttribute("tabindex", active ? "0" : "-1");
      panel.hidden = !active;
    });
  }
  order.forEach(id=> $("#"+id).addEventListener("click", ()=>{ activate(id); $("#"+id).focus(); }));
  $(".tabs").addEventListener("keydown", e=>{
    const tabs = order.map(id=>$("#"+id));
    const idx = tabs.indexOf(document.activeElement);
    if(idx<0) return;
    if(e.key==="ArrowRight"){ e.preventDefault(); tabs[(idx+1)%tabs.length].click(); }
    if(e.key==="ArrowLeft"){ e.preventDefault(); tabs[(idx-1+tabs.length)%tabs.length].click(); }
    if(e.key==="Home"){ e.preventDefault(); tabs[0].click(); }
    if(e.key==="End"){ e.preventDefault(); tabs[tabs.length-1].click(); }
  });
})();

/* -------------------- Переключатель темы (общий ключ) -------------------- */
(function(){
  const KEY = "hrp_theme";
  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  const saved = localStorage.getItem(KEY);
  const start = saved || (prefersDark ? "dark" : "light");
  function apply(theme){
    document.documentElement.setAttribute("data-theme", theme);
    document.documentElement.style.colorScheme = (theme === "dark") ? "dark" : "light";
    localStorage.setItem(KEY, theme);
    const btn = document.getElementById("toggleTheme");
    if(btn) btn.setAttribute("aria-pressed", theme === "dark" ? "true" : "false");
  }
  apply(start);
  const btn = document.getElementById("toggleTheme");
  btn && btn.addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme")==="dark"?"dark":"light";
    apply(cur==="dark"?"light":"dark");
  });
})();

/* -------------------- ДАННЫЕ: докторские крафты -------------------- */
const DOCTOR_CRAFTS = [
  {id:"aptechka-heroine", name:"Аптечка на героине", output:1, stack:10, timeSec:60, ing:[
    {name:"Героин",qty:1,unit:"шт"},
    {name:"Противоядие",qty:1,unit:"шт"},
    {name:"Бинт стерильный",qty:1,unit:"шт"}]},

  {id:"aptechka-opium", name:"Аптечка на опиуме", output:1, stack:10, timeSec:60, ing:[
    {name:"Опиум",qty:1,unit:"шт"},
    {name:"Противоядие",qty:1,unit:"шт"},
    {name:"Бинт стерильный",qty:1,unit:"шт"}]},

  {id:"bint-prost", name:"Бинт простой", output:1, stack:20, timeSec:30, ing:[
    {name:"Волокна древесные",qty:1,unit:"шт"},
    {name:"Мёд",qty:1,unit:"шт"},
    {name:"Алоэ",qty:1,unit:"шт"}]},

  {id:"bint-steril", name:"Бинт стерильный", output:2, stack:20, timeSec:40, ing:[
    {name:"Волокна древесные",qty:1,unit:"шт"},
    {name:"Алоэ",qty:1,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"}]},

  {id:"geroin", name:"Героин", output:2, stack:10, timeSec:60, ing:[
    {name:"Красная малина",qty:2,unit:"шт"},
    {name:"Морфин",qty:2,unit:"шт"},
    {name:"Яд",qty:1,unit:"шт"}]},

  {id:"laudanum", name:"Лауданум", output:1, stack:10, timeSec:60, ing:[
    {name:"Алоэ",qty:2,unit:"шт"},
    {name:"Змеиный яд",qty:1,unit:"шт"},
    {name:"Опиум",qty:2,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"}]},

  {id:"maz-lechebnaya", name:"Лечебная мазь", output:1, stack:10, timeSec:60, ing:[
    {name:"Алоэ",qty:1,unit:"шт"},
    {name:"Животный жир",qty:1,unit:"шт"},
    {name:"Змеиный яд",qty:1,unit:"шт"},
    {name:"Тысячелистник",qty:2,unit:"шт"}]},

  {id:"morfin", name:"Морфин", output:1, stack:10, timeSec:60, ing:[
    {name:"Прерийный мак",qty:1,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"},
    {name:"Стеклянная бутылка",qty:1,unit:"шт"}]},

  {id:"nast-zheludok", name:'Настойка "Здоровый желудок"', output:1, stack:15, timeSec:20, ing:[
    {name:"Алоэ",qty:1,unit:"шт"},
    {name:"Аляскинский женьшень",qty:1,unit:"шт"},
    {name:"Прерийный мак",qty:1,unit:"шт"},
    {name:"Тысячелистник",qty:2,unit:"шт"}]},

  {id:"nast-kosti", name:'Настойка "Крепкие кости"', output:1, stack:15, timeSec:20, ing:[
    {name:"Животный жир",qty:1,unit:"шт"},
    {name:"Прерийный мак",qty:1,unit:"шт"},
    {name:"Тысячелистник",qty:2,unit:"шт"}]},

  {id:"nast-cold", name:"Настойка от простуды", output:1, stack:15, timeSec:20, ing:[
    {name:"Алоэ",qty:1,unit:"шт"},
    {name:"Аляскинский женьшень",qty:1,unit:"шт"},
    {name:"Прерийный мак",qty:1,unit:"шт"}]},

  {id:"opium", name:"Опиум", output:1, stack:10, timeSec:60, ing:[
    {name:"Прерийный мак",qty:2,unit:"шт"},
    {name:"Стеклянная бутылка",qty:1,unit:"шт"},
    {name:"Яд",qty:2,unit:"шт"}]},

  {id:"otvar-travy", name:"Отвар на травах", output:1, stack:15, timeSec:60, ing:[
    {name:"Алоэ",qty:1,unit:"шт"},
    {name:"Английская булава",qty:2,unit:"шт"},
    {name:"Гриб-зонтик",qty:2,unit:"шт"},
    {name:"Ползучий тимьян",qty:1,unit:"шт"}]},

  {id:"paracetamol", name:"Парацетамол", output:1, stack:10, timeSec:60, ing:[
    {name:"Агава",qty:1,unit:"шт"},
    {name:"Соль",qty:1,unit:"шт"},
    {name:"Стеклянная бутылка",qty:1,unit:"шт"},
    {name:"Яд",qty:1,unit:"шт"}]},

  {id:"detox", name:"Детокс", output:1, stack:10, timeSec:60, ing:[
    {name:"Вода",qty:1,unit:"шт"},
    {name:"Змеиный яд",qty:1,unit:"шт"},
    {name:"Кровавый цветок",qty:3,unit:"шт"},
    {name:"Молочай",qty:2,unit:"шт"},
    {name:"Опиум",qty:2,unit:"шт"},
    {name:"Парацетамол",qty:1,unit:"шт"},
    {name:"Спирт",qty:2,unit:"шт"},
    {name:"Шалфей олеандровый",qty:2,unit:"шт"}]},

  {id:"protivoyadie", name:"Противоядие", output:1, stack:10, timeSec:60, ing:[
    {name:"Зимняя ягода",qty:1,unit:"шт"},
    {name:"Змеиный яд",qty:1,unit:"шт"},
    {name:"Чок Дейзи",qty:1,unit:"шт"}]},

  {id:"maz-salic", name:"Салициловая мазь", output:1, stack:10, timeSec:60, ing:[
    {name:"Животный жир",qty:1,unit:"шт"},
    {name:"Мягкая древесина",qty:1,unit:"шт"},
    {name:"Шалфей олеандровый",qty:2,unit:"шт"}]},

  {id:"tonik-toniz", name:"Тонизирующий тоник", output:2, stack:15, timeSec:60, ing:[
    {name:"Агава",qty:1,unit:"шт"},
    {name:"Аляскинский женьшень",qty:1,unit:"шт"},
    {name:"Дикая мята",qty:1,unit:"шт"},
    {name:"Сахар",qty:2,unit:"шт"},
    {name:"Стеклянная бутылка",qty:1,unit:"шт"},
    {name:"Черная смородина",qty:2,unit:"шт"}]},

  {id:"tonik-hinin", name:"Тоник с Хинином", output:2, stack:15, timeSec:60, ing:[
    {name:"Алоэ",qty:2,unit:"шт"},
    {name:"Мягкая древесина",qty:1,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"},
    {name:"Стеклянная бутылка",qty:1,unit:"шт"}]},

  {id:"nast-uspokaiv", name:"Успокаивающая настойка", output:1, stack:15, timeSec:20, ing:[
    {name:"Алоэ",qty:1,unit:"шт"},
    {name:"Американский женьшень",qty:1,unit:"шт"},
    {name:"Дикая мята",qty:2,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"}]},

  {id:"hirurg-nabor", name:"Хирургический набор", output:1, stack:10, timeSec:45, ing:[
    {name:"Вода",qty:1,unit:"шт"},
    {name:"Бинт простой",qty:1,unit:"шт"},
    {name:"Змеиный яд",qty:1,unit:"шт"},
    {name:"Опиум",qty:1,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"}]},

  {id:"yad", name:"Яд", output:2, stack:20, timeSec:45, ing:[
    {name:"Змеиный яд",qty:1,unit:"шт"},
    {name:"Нитрит",qty:3,unit:"шт"},
    {name:"Прерийный мак",qty:3,unit:"шт"}]},

  {id:"nast-cold", name:"Настойка от простуды", output:1, stack:15, timeSec:20, ing:[
    {name:"Алоэ",qty:1,unit:"шт"},
    {name:"Аляскинский женьшень",qty:1,unit:"шт"},
    {name:"Прерийный мак",qty:1,unit:"шт"}]},

  {id:"syrop-dr-kaf", name:'Сироп "Др. Каф"', output:1, stack:15, timeSec:55, ing:[
    {name:"Вода",qty:1,unit:"шт"},
    {name:"Листья коки",qty:4,unit:"шт"},
    {name:"Нитрит",qty:1,unit:"шт"},
    {name:"Сахар",qty:4,unit:"шт"},
    {name:"Спирт",qty:1,unit:"шт"}]}
];
const DO_NOT_EXPAND = new Set([]);

const craftById   = id   => DOCTOR_CRAFTS.find(c=>c.id===id) || null;
const craftByName = name => DOCTOR_CRAFTS.find(c=>normName(c.name)===normName(name)) || null;

/* Человеческий формат времени */
function fmtTime(sec){
  sec = Math.round(sec||0);
  const m = Math.floor(sec/60), s = sec%60;
  if(m && s) return `${m} мин ${s} с`;
  if(m) return `${m} мин`;
  return `${s} с`;
}

/* -------------------- ВИТРИНА: план крафтов -------------------- */
let plan = []; // [{id, qty}] — qty = сколько РАЗ запустить рецепт
const PLAN_KEY = "hrp_doctor_plan_v3";

/* Плитка */
function tileHTML(craft, plannedQty){
  const totalOut = plannedQty * (craft.output||1);
  const overflow = craft.stack ? (totalOut > craft.stack) : false;
  return `
    <article class="tile" data-id="${craft.id}">
      <div style="display:flex; justify-content:space-between; gap:8px; align-items:flex-start">
        <h4>${craft.name}</h4>
        <span class="chip" title="Макс. стак">${craft.stack ? ("стак "+craft.stack) : "—"}</span>
      </div>
      <div class="chip" title="Выход и план">⏱ ${fmtTime(craft.timeSec)} · выход: ×${craft.output} · план: ×<span class="planN">${plannedQty}</span> → всего: <b class="totalOut">${totalOut}</b>${overflow? ' <span class="badge" style="border-color: var(--danger); color: var(--danger)">>стак</span>' : ''}</div>
      <div>
        <div class="small muted" style="margin-bottom:4px">Ингредиенты на 1 крафт:</div>
        <ul class="ing">
          ${craft.ing.map(i=>`<li>${i.name} — <b>${i.qty}</b> ${i.unit||"шт"}</li>`).join("")}
        </ul>
      </div>
      <div class="qtybar">
        <button class="btn ghost" data-act="dec" aria-label="Уменьшить">−</button>
        <input class="qty" type="number" min="0" step="1" value="${plannedQty}" aria-label="План крафтов">
        <button class="btn ghost" data-act="inc" aria-label="Увеличить">+</button>
        <button class="btn danger" data-act="clr" style="margin-left:auto">Сброс</button>
      </div>
    </article>
  `;
}

/* Рендер плиток */
function renderTiles(){
  const q = normName($("#craftSearch").value || "");
  const tiles = $("#tiles");
  const filtered = DOCTOR_CRAFTS
    .filter(c=> !q || normName(c.name).includes(q))
    .sort((a,b)=> a.name.localeCompare(b.name,'ru'));
  const qtyOf = id => (plan.find(x=>x.id===id)?.qty || 0);
  tiles.innerHTML = filtered.map(c=>tileHTML(c, qtyOf(c.id))).join("");

  tiles.querySelectorAll(".tile").forEach(tile=>{
    const id = tile.dataset.id;
    const inp = tile.querySelector("input.qty");
    const setQty = (n)=>{
      const qty = Math.max(0, Number.isFinite(+n)? Math.floor(+n) : 0);
      const i = plan.findIndex(x=>x.id===id);
      if(qty===0){ if(i>=0) plan.splice(i,1); }
      else { if(i>=0) plan[i].qty = qty; else plan.push({id, qty}); }
      tile.querySelector(".planN").textContent = qty;
      const craft = craftById(id);
      tile.querySelector(".totalOut").textContent = (qty * (craft.output||1));
      renderMaterials();
      persistPlan();
    };
    tile.addEventListener("click",(e)=>{
      const act = e.target?.dataset?.act;
      if(!act) return;
      e.preventDefault();
      const cur = Math.max(0, +inp.value||0);
      if(act==="inc") setQty(cur+1);
      if(act==="dec") setQty(Math.max(0,cur-1));
      if(act==="clr") setQty(0);
      inp.value = plan.find(x=>x.id===id)?.qty || 0;
    });
    inp.addEventListener("change", ()=> setQty(inp.value));
  });
}

/* -------------------- ПОСТРОЕНИЕ ДЕРЕВА, ИТОГА И ПОРЯДКА -------------------- */
function makeTreeByCrafts(recipeId, craftsCount, expandRaw, visited=new Set()){
  const rec = craftById(recipeId); if(!rec) return null;
  const node = {type:'craft', id:rec.id, name:rec.name, output:rec.output, plannedCrafts:craftsCount, children:[]};

  for(const ing of rec.ing){
    const requiredItems = ing.qty * craftsCount;
    const sub = craftByName(ing.name);
    const canExpand = expandRaw && sub && !DO_NOT_EXPAND.has(sub.id) && !visited.has(sub.id);

    if(canExpand){
      const craftsNeeded = requiredItems / sub.output;
      visited.add(sub.id);
      const child = makeTreeByItems(sub.id, requiredItems, expandRaw, visited);
      visited.delete(sub.id);
      child.craftsNeeded = craftsNeeded;
      child.requiredItems = requiredItems;
      node.children.push(child);
    }else{
      node.children.push({type:'raw', name:ing.name, unit:ing.unit||"шт", qty:requiredItems});
    }
  }
  return node;
}
function makeTreeByItems(recipeId, itemsNeeded, expandRaw, visited=new Set()){
  const rec = craftById(recipeId); if(!rec) return null;
  const craftsNeeded = itemsNeeded / rec.output;
  const node = {type:'craft', id:rec.id, name:rec.name, output:rec.output, requiredItems:itemsNeeded, craftsNeeded, children:[]};

  for(const ing of rec.ing){
    const subItems = ing.qty * craftsNeeded;
    const sub = craftByName(ing.name);
    const canExpand = expandRaw && sub && !DO_NOT_EXPAND.has(sub.id) && !visited.has(sub.id);

    if(canExpand){
      visited.add(sub.id);
      const child = makeTreeByItems(sub.id, subItems, expandRaw, visited);
      visited.delete(sub.id);
      node.children.push(child);
    }else{
      node.children.push({type:'raw', name:ing.name, unit:ing.unit||"шт", qty:subItems});
    }
  }
  return node;
}

/* Сбор сырья: сохраняем «красивое» имя, ключ — нормализованное */
function collectLeaves(node, bag=new Map()){
  if(!node) return bag;
  if(node.type==='raw'){
    const key = normName(node.name)+"|"+(node.unit||"");
    const prev = bag.get(key) || {name: node.name, unit: node.unit||"шт", qty:0};
    prev.qty += node.qty;
    bag.set(key, prev);
    return bag;
  }
  if(node.children) node.children.forEach(ch=>collectLeaves(ch, bag));
  return bag;
}
function leavesToArray(bag){
  return Array.from(bag.values()).map(it=>({
    name: it.name,
    unit: it.unit,
    qty: Math.round((it.qty + Number.EPSILON)*100)/100
  })).sort((a,b)=> a.name.localeCompare(b.name,'ru'));
}

/* Потребности в промежуточных крафтах + граф зависимостей */
function collectCraftNeeds(node, needs=new Map(), edges=new Map()){
  if(!node || node.type!=='craft' || !node.children) return {needs, edges};
  node.children.forEach(ch=>{
    if(ch.type==='craft'){
      needs.set(ch.id, (needs.get(ch.id)||0) + (ch.requiredItems || 0));
      if(!edges.has(node.id)) edges.set(node.id, new Set());
      edges.get(node.id).add(ch.id);
      collectCraftNeeds(ch, needs, edges);
    }
  });
  return {needs, edges};
}
function craftDepth(id, edges, memo=new Map()){
  if(memo.has(id)) return memo.get(id);
  const deps = Array.from(edges.get(id)||[]);
  const d = deps.length ? 1 + Math.max(...deps.map(cid=>craftDepth(cid, edges, memo))) : 1;
  memo.set(id,d); return d;
}

/* -------------------- РЕНДЕР «ДЕРЕВА», «ИТОГА», «ПОРЯДКА» -------------------- */
function renderTree(){
  const expandRaw = $("#expandToRaw").checked;
  const wrap = $("#matTree");
  wrap.innerHTML = "";

  if(plan.length===0){
    wrap.innerHTML = `<div class="small muted">Нет выбранных крафтов — добавьте план на плитках ниже.</div>`;
    return;
  }

  for(const line of plan){
    const rec = craftById(line.id); if(!rec) continue;
    const tree = makeTreeByCrafts(line.id, line.qty, expandRaw, new Set([line.id]));
    const header = `<b>${rec.name}</b> — план: ×${line.qty}, выход ×${rec.output} → всего: <b>${line.qty*rec.output}</b>`;
    const group = document.createElement("div");
    group.className = "group";
    group.innerHTML = `
      <details open>
        <summary>${header}</summary>
        ${renderTreeChildren(tree.children)}
      </details>
    `;
    wrap.appendChild(group);
  }

  function renderTreeChildren(children){
    if(!children || !children.length) return `<div class="small muted">— без ингредиентов —</div>`;
    return `<ul>${children.map(renderNode).join("")}</ul>`;
  }
  function renderNode(n){
    if(n.type==='raw'){
      return `<li>${n.name} — <b>${fmt(n.qty)}</b> ${n.unit} <span class="badge raw">сырьё</span></li>`;
    }
    const approxCrafts = n.craftsNeeded ?? ( (n.requiredItems||0) / (n.output||1) );
    const head = `${n.name} — нужно предметов: <b>${fmt(n.requiredItems||0)}</b> · выход ×${n.output} → крафтов: <b>${fmt(approxCrafts)}</b> <span class="badge craft">крафт</span>`;
    return `<li>
      <details>
        <summary>${head}</summary>
        ${renderTreeChildren(n.children)}
      </details>
    </li>`;
  }
}
function renderTotals(){
  const expandRaw = $("#expandToRaw").checked;
  const bag = new Map();
  for(const line of plan){
    const tree = makeTreeByCrafts(line.id, line.qty, expandRaw, new Set([line.id]));
    collectLeaves(tree, bag);
  }
  const arr = leavesToArray(bag);
  const tb = $("#materialsTable tbody");
  if(arr.length===0){
    tb.innerHTML = `<tr><td colspan="3" class="small muted">Нет выбранных крафтов — добавьте план на плитках ниже.</td></tr>`;
    return;
  }
  tb.innerHTML = arr.map(t=>`
    <tr>
      <td>${t.name}</td>
      <td class="right">${fmt(t.qty)}</td>
      <td>${t.unit}</td>
    </tr>`).join("");
}
function renderOrder(){
  const expandRaw = $("#expandToRaw").checked;
  const needs = new Map(); // craftId -> itemsNeeded
  const edges = new Map(); // craftId -> Set(deps)

  for(const line of plan){
    const tree = makeTreeByCrafts(line.id, line.qty, expandRaw, new Set([line.id]));
    const {needs:n, edges:e} = collectCraftNeeds(tree);
    n.forEach((v,k)=>needs.set(k, (needs.get(k)||0) + v));
    e.forEach((set,k)=>{
      if(!edges.has(k)) edges.set(k, new Set());
      set.forEach(x=>edges.get(k).add(x));
    });
  }

  let rows = [];
  needs.forEach((itemsNeeded, craftId)=>{
    const rec = craftById(craftId); if(!rec) return;
    const craftsApprox = itemsNeeded / (rec.output||1);
    rows.push({id:craftId, name:rec.name, items:itemsNeeded, out:rec.output, crafts:craftsApprox});
  });

  const tb = $("#craftOrderTable tbody");
  if(rows.length===0){
    tb.innerHTML = `<tr><td colspan="5" class="small muted">Нет зависимостей — выберите крафты ниже или включите разворачивание до сырья.</td></tr>`;
    return;
  }

  // глубина (чем глубже — тем раньше шаг)
  const depthMemo = new Map();
  rows.forEach(r=>{ if(!edges.has(r.id)) edges.set(r.id, new Set()); });
  rows.forEach(r=> r.depth = craftDepth(r.id, edges, depthMemo));
  rows.sort((a,b)=> b.depth - a.depth || a.name.localeCompare(b.name,'ru'));

  const uniqueDepths = Array.from(new Set(rows.map(r=>r.depth))).sort((a,b)=>b-a);
  const depthToStep = new Map(uniqueDepths.map((d,i)=>[d,i+1]));
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td class="right">${depthToStep.get(r.depth)}</td>
      <td>${r.name}</td>
      <td class="right">${fmt(r.items)}</td>
      <td class="right">×${r.out}</td>
      <td class="right">${fmt(r.crafts)}</td>
    </tr>
  `).join("");
}

/* Главный рендер материалов с учётом подтаба */
let MAT_MODE = "tree"; // 'tree' | 'totals' | 'order'
function renderMaterials(){
  $$(".subtabs .tab").forEach(b=> b.setAttribute("aria-selected", b.dataset.mode===MAT_MODE ? "true" : "false"));
  $("#totalsWrap").hidden = (MAT_MODE!=="totals");
  $("#orderWrap").hidden  = (MAT_MODE!=="order");
  renderTree(); renderTotals(); renderOrder();
}

/* Сохранение/восстановление плана */
function persistPlan(){ localStorage.setItem(PLAN_KEY, JSON.stringify(plan)); }
function restorePlan(){
  try{
    const raw = JSON.parse(localStorage.getItem(PLAN_KEY)||"[]");
    if(Array.isArray(raw)) plan = raw.filter(x=>craftById(x.id) && Number.isFinite(+x.qty) && +x.qty>0)
                                     .map(x=>({id:x.id, qty:Math.floor(+x.qty)}));
  }catch(e){ plan = []; }
}

/* Инициализация калькулятора */
function initDoctorTiles(){
  restorePlan();
  renderTiles();
  renderMaterials();
  $("#craftSearch").addEventListener("input", renderTiles);
  $("#expandToRaw").addEventListener("change", renderMaterials);
  $$(".subtabs .tab").forEach(b=> b.addEventListener("click", ()=>{ MAT_MODE = b.dataset.mode; renderMaterials(); }));
  // Очистить всё
  $("#planClearAll").addEventListener("click", ()=>{
    plan = [];
    persistPlan();
    renderTiles();
    renderMaterials();
  });
}
initDoctorTiles();

/* -------------------- ПРАЙС и калькулятор оплаты -------------------- */
const SERVICES = [
  ["Лечение аптечкой (реанимация)", "$15"],
  ["Лечение тяжёлой травмы (операция)", "$18"],
  ["Детокс", "$50"]
];
const GOODS = [
  ["Бинты (розница)", "$3 /шт", ""],
  ["Бинты (для полиции)", "$2.5 /шт", ""],
  ["Тонизирующий тоник", "$3 /шт", ""],
  ["Лечебная мазь", "$4 /шт", ""],
  ["Салициловая мазь", "$3 /шт", ""],
  ["Отвар на травах", "$3 /шт", ""],
  ["Противоядие", "$3 /шт", ""],
  ["Настойка «крепкие кости»", "$4 /шт", ""],
  ["Настойка «крепкий желудок»", "$4 /шт", "в крафтах: «Здоровый желудок»"],
  ["Успокаивающая настойка", "$4 /шт", ""],
  ["Настойка от простуды", "$1 /шт", ""],
  ["Сироп Доктора Кафа", "$6 /шт", ""],
  ["Кровь Вождя", "$6 /шт", ""]
];
(function(){
  $("#services").innerHTML = SERVICES.map(([n,p])=>`<tr><td>${n}</td><td class="right mono">${p}</td></tr>`).join("");
  $("#goods").innerHTML = GOODS.map(([n,p,note])=>`<tr><td>${n}</td><td class="right mono">${p}</td><td class="small muted">${note||""}</td></tr>`).join("");
})();

/* Чёткая модель цен (для калькулятора) */
const PRICING = [
  // {id:"svc_osmotr", name:"Осмотр", type:"service", price: 2}, // удалено
  {id:"svc_reanim", name:"Лечение аптечкой (реанимация)", type:"service", price: 15},
  {id:"svc_oper",   name:"Лечение тяжёлой травмы (операция)", type:"service", price: 18},
  {id:"svc_detox",  name:"Детокс", type:"service", price: 50},

  {id:"g_bandage_retail", name:"Бинт (розница)", type:"good", pricing:{base:3}},
  {id:"g_bandage_police", name:"Бинт (для полиции)", type:"good", pricing:{base:2.5}},
  {id:"g_tonik_toniz", name:"Тонизирующий тоник", type:"good", pricing:{base:3}},
  {id:"g_maz_lechebnaya", name:"Лечебная мазь", type:"good", pricing:{base:4}},
  {id:"g_maz_salic", name:"Салициловая мазь", type:"good", pricing:{base:3}},
  {id:"g_otvar", name:"Отвар на травах", type:"good", pricing:{base:3}},
  {id:"g_antidote", name:"Противоядие", type:"good", pricing:{base:3}},
  {id:"g_nast_kosti", name:'Настойка «крепкие кости»', type:"good", pricing:{base:4}},
  {id:"g_nast_zheludok", name:'Настойка «крепкий желудок»', type:"good", pricing:{base:4}},
  {id:"g_nast_uspok", name:"Успокаивающая настойка", type:"good", pricing:{base:4}},
  {id:"g_nast_cold", name:"Настойка от простуды", type:"good", pricing:{base:1}},
  {id:"g_syrop_kaf", name:"Сироп Доктора Кафа", type:"good", pricing:{base:6}},
  {id:"g_krov_vozhdya", name:"Кровь Вождя", type:"good", pricing:{base:6}}
];
(function initPaySelect(){
  const sel = document.getElementById("payItem");
  const groups = {service: document.createElement("optgroup"), good: document.createElement("optgroup")};
  groups.service.label = "Услуги"; groups.good.label = "Товары";
  PRICING.forEach(p=>{
    const o = document.createElement("option");
    o.value = p.id; o.textContent = p.name;
    groups[p.type].appendChild(o);
  });
  sel.appendChild(groups.service);
  sel.appendChild(groups.good);
})();
const payCart = []; // [{id, qty}]
function formatMoney(n){ return "$" + (Number(n)||0).toFixed(2); }
function findPriceItem(id){ return PRICING.find(p=>p.id===id); }
function unitPriceFor(item){ // скидок нет
  if(item.type === "service"){ return item.price; }
  const rule = item.pricing || {base:0};
  return rule.base;
}
function renderPay(){
  const tb = document.querySelector("#payTable tbody");
  let total = 0;
  tb.innerHTML = payCart.map((line, i)=>{
    const item = findPriceItem(line.id);
    const unit = unitPriceFor(item);
    const sum = unit * line.qty; total += sum;
    return `<tr>
      <td>${item.name}</td>
      <td class="right">${line.qty}</td>
      <td class="right mono">${formatMoney(unit)}</td>
      <td class="right mono">${formatMoney(sum)}</td>
      <td class="right">
        <button class="btn ghost" data-act="inc" data-i="${i}">+1</button>
        <button class="btn ghost" data-act="dec" data-i="${i}">−1</button>
        <button class="btn danger" data-act="del" data-i="${i}">Удалить</button>
      </td>
    </tr>`;
  }).join("");
  document.getElementById("payTotal").textContent = formatMoney(total);
  tb.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const i = +b.dataset.i, act = b.dataset.act;
      if(act==="inc") payCart[i].qty++;
      if(act==="dec") payCart[i].qty = Math.max(1, payCart[i].qty - 1);
      if(act==="del") payCart.splice(i,1);
      renderPay();
    });
  });
}
document.getElementById("payAdd").addEventListener("click", ()=>{
  const id = document.getElementById("payItem").value;
  const qty = Math.max(1, +document.getElementById("payQty").value || 1);
  const idx = payCart.findIndex(x=>x.id===id);
  if(idx>=0) payCart[idx].qty += qty; else payCart.push({id, qty});
  renderPay();
});
document.getElementById("payClear").addEventListener("click", ()=>{ payCart.length = 0; renderPay(); });
renderPay();
</script>
</body>
</html>


