<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ–¥–µ–ø ‚Äî —Å–ª–æ—Ç-—Å–∞—Ç–∏—Ä–∞</title>
<style>
  :root{
    --bg:#0f1220; --panel:#151936; --panel-2:#10132a;
    --line:#2b315f; --line-2:#333a77;
    --text:#e9ecff; --muted:#98a0c6;
    --accent:#69ff9a; --accent-2:#9aa8ff; --danger:#ff5978;
    --shadow:0 12px 34px rgba(0,0,0,.35); --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
    background: radial-gradient(1200px 800px at 70% -10%, #23284d 0%, #121428 40%, #0b0e1f 100%), var(--bg);
    color:var(--text); display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{width:min(1100px,100%); display:grid; gap:16px; grid-template-columns: 360px 1fr}
  header{
    grid-column:1/-1; background:linear-gradient(180deg,#1e2240,#14182d);
    border:1px solid #2c325d; border-radius:14px; padding:12px 14px; box-shadow:var(--shadow);
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  h1{margin:0; font-size:20px; display:flex; gap:10px; align-items:center}
  .tag{font-size:12px; color:var(--muted); border:1px solid #2f3564; padding:2px 8px; border-radius:999px}
  .chip{background:#10132a; border:1px solid #2b2f5f; padding:8px 10px; border-radius:12px; display:flex; gap:8px; align-items:center}
  .toggles{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .toggle{display:flex; gap:6px; align-items:center; font-size:12px; color:var(--muted)}
  .rules-link{font-size:12px; color:#a7afff; text-decoration:underline; cursor:pointer}
  .panel{background:linear-gradient(180deg,#151936,#10132a); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow)}
  .left{padding:14px; display:flex; flex-direction:column; gap:12px}
  .hero{background:linear-gradient(180deg,#1a1f47,#111534); border:1px solid #2a2f60; border-radius:12px; padding:12px}
  .hero-inner{display:grid; grid-template-columns:90px 1fr; gap:12px; align-items:center}
  .ignacio{
    width:88px; height:88px; border-radius:50%;
    background: radial-gradient(circle at 35% 30%, #ffd77a, #ffbf3f 60%, #d18b1a 100%);
    border:3px solid #2b1800; display:flex; align-items:center; justify-content:center; font-size:42px;
    box-shadow: inset 0 -8px 20px rgba(0,0,0,.25), 0 10px 30px rgba(0,0,0,.35);
  }
  .ignacio.win{animation: win-bounce 1s ease}
  .ignacio.lose{animation: lose-sad 1s ease}
  @keyframes win-bounce{0%{transform:none}30%{transform:translateY(-10px) scale(1.05)}100%{transform:none}}
  @keyframes lose-sad{0%{transform:none}40%{transform:translateY(6px) rotate(3deg)}100%{transform:none}}
  .hero-name{font-weight:800}.hero-sub{font-size:12px; color:var(--muted)}
  .props{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .prop{font-size:12px; color:var(--muted); border:1px dashed #3a3f6e; padding:4px 8px; border-radius:999px}
  .prop.sold{opacity:.45; text-decoration:line-through}

  .inv-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
  .pill{border:1px solid #3a427d; border-radius:999px; padding:2px 8px; color:var(--muted); font-size:12px}
  .inv-tabs{display:flex; gap:8px}
  .tab{border:1px solid #39407a; background:#0f1331; color:#cfd4ff; padding:6px 10px; border-radius:10px; cursor:pointer}
  .tab.active{background:#222a66}
  .inventory{display:flex; flex-direction:column; gap:8px; max-height:240px; overflow:auto; padding-right:6px}
  .item{display:grid; grid-template-columns:30px 1fr auto; gap:10px; align-items:center;
        background:linear-gradient(180deg,#14193a,#0f1230); border:1px solid #2b315e; border-radius:10px; padding:8px}
  .item.gone{opacity:.55; filter:grayscale(1)}
  .dep{border:0; background:#242a56; color:#e7eaff; padding:6px 10px; border-radius:10px; border:1px solid #39407a; cursor:pointer}
  .buy{border:0; background:linear-gradient(180deg,#9aa8ff,#6c7aff); color:#0d1230; padding:6px 10px; border-radius:10px; cursor:pointer}

  .left-footer{margin-top:10px; padding-top:10px; border-top:1px solid #2b315f; display:flex; justify-content:space-between; align-items:center; gap:10px}
  .reset-btn{border:0; background:linear-gradient(180deg,#ff8aa2,#ff5b7a); color:#2b0010; font-weight:700; padding:8px 12px; border-radius:10px; cursor:pointer}

  .right{padding:14px; display:flex; flex-direction:column; gap:12px}

  .slot{
    background: radial-gradient(600px 300px at 50% 0%, #1f2553, #121534 60%), #0f1229;
    border:1px solid var(--line); border-radius:14px; padding:14px; position:relative; overflow:hidden; min-height:410px;
    transition: box-shadow .4s ease;
  }
  .slot.win-sticky{ box-shadow: 0 0 0 2px rgba(105,255,154,.4), 0 0 28px rgba(105,255,154,.35), inset 0 0 24px rgba(105,255,154,.18) }

  .reels{position:relative; display:grid; grid-template-columns:repeat(3,1fr); gap:12px; padding:14px; background:#0f1333; border:1px solid var(--line-2); border-radius:12px; box-shadow: inset 0 0 30px rgba(0,0,0,.45)}
  .reel{height:180px; overflow:hidden; background:linear-gradient(180deg,#0f1331,#0a0e27); border:1px solid #2c3165; border-radius:10px; position:relative}
  .reel::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      linear-gradient(to bottom, transparent calc(33.333% - 1px), rgba(255,255,255,.16) calc(33.333% - 1px), rgba(255,255,255,.16) calc(33.333% + 1px), transparent calc(33.333% + 1px)),
      linear-gradient(to bottom, transparent calc(66.666% - 1px), rgba(255,255,255,.16) calc(66.666% - 1px), rgba(255,255,255,.16) calc(66.666% + 1px), transparent calc(66.666% + 1px));
  }
  .reel:not(:last-child)::after{
    content:""; position:absolute; top:0; right:-6px; bottom:0; width:12px; pointer-events:none;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.16), transparent);
  }
  .strip{position:absolute; left:0; right:0; top:0; will-change:transform}
  .cell{height:60px; display:flex; align-items:center; justify-content:center; font-size:34px; text-shadow:0 2px 0 rgba(0,0,0,.45); filter:drop-shadow(0 4px 10px rgba(0,0,0,.35))}

  .controls{display:grid; grid-template-columns: 1fr auto 1fr; gap:12px; align-items:center; margin-top:12px}
  .betbox{display:flex; align-items:center; gap:8px; justify-content:flex-start}
  .btn{border:0; background:linear-gradient(180deg,#5efc7a,#34dc5a); color:#082313; font-weight:800; padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:0 6px 20px rgba(79,255,140,.25)}
  .spin-big{justify-self:center; font-size:18px; padding:14px 24px}
  .bet-ctrl{display:flex; gap:6px; align-items:center}
  .step{border:1px solid #39407a; background:#1a204b; color:#e7eaff; width:34px; height:34px; border-radius:8px; font-weight:800; cursor:pointer}
  .bet-slider{width:220px}
  .statbox{justify-self:end; display:flex; gap:12px; align-items:center}
  .auto-btn{background:linear-gradient(180deg,#9aa8ff,#6c7aff); color:#0d1230}

  .log{background:linear-gradient(180deg,#13163b,#0e1130); border:1px solid #2d3364; border-radius:12px; padding:10px; min-height:72px; max-height:172px; overflow:auto; font-size:13px}
  .log p{margin:6px 0}
  .post{padding:6px 8px; background:#0e1433; border:1px solid #2a3266; border-radius:8px}

  .win-flash{position:absolute; inset:0; pointer-events:none; opacity:0; background:radial-gradient(400px 200px at 50% 50%, rgba(191,255,212,.65), rgba(191,255,212,0) 60%); transition:opacity .5s}
  .win-flash.show{opacity:1; animation:flash 800ms ease}
  @keyframes flash{0%{opacity:1}100%{opacity:0}}
  .footer{display:flex; gap:10px; align-items:center; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:8px}
  .small{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üé∞ –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ–¥–µ–ø <span class="tag">—Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–∏–π —Å–ª–æ—Ç</span></h1>
      <div class="toggles">
        <div class="chip">–ë–∞–ª–∞–Ω—Å: <b id="balance">‚Äî</b></div>
        <div class="chip">–°—Ç–∞–≤–∫–∞: <b id="betLabel">‚Äî</b></div>
        <div class="chip">RTP ~92% ‚Ä¢ <span class="rules-link" id="rulesLink">–ü—Ä–∞–≤–∏–ª–∞ –∏ –≤—ã–ø–ª–∞—Ç—ã</span></div>
        <label class="toggle"><input type="checkbox" id="sfxToggle" checked/> –ó–≤—É–∫–∏</label>
        <label class="toggle"><input type="checkbox" id="ttsToggle"/> –û–∑–≤—É—á–∫–∞</label>
      </div>
    </header>

    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div class="panel left">
      <div class="hero">
        <div class="hero-inner">
          <div class="ignacio" id="ignacio">üòê</div>
          <div>
            <div class="hero-name">–ò–≥–Ω–∞—Å–∏–æ –î–æ–¥–µ–ø–æ–≤</div>
            <div class="hero-sub">¬´–µ—â—ë –æ–¥–∏–Ω —Å–ø–∏–Ω ‚Äî –∏ —Ç–æ—á–Ω–æ –≤ –ø–ª—é—Å¬ª</div>
            <div class="props" id="props"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="inv-head">
          <b>–ò–º—É—â–µ—Å—Ç–≤–æ –ò–≥–Ω–∞—Å–∏–æ</b>
          <div class="pill" id="invSummary">–î–æ—Å—Ç—É–ø–Ω–æ –∫ –¥–µ–ø—É: ‚Äî</div>
        </div>
        <div class="inv-tabs">
          <button class="tab active" id="tabAvailable">–î–æ—Å—Ç—É–ø–Ω–æ</button>
          <button class="tab" id="tabSold">–ü—Ä–æ–¥–∞–Ω–æ</button>
          <button class="tab" id="tabAll">–í—Å–µ</button>
        </div>
        <div class="inventory" id="inventory"></div>
        <div class="left-footer">
          <span class="small">–ù–∞–¥–æ–µ–ª–æ —Å—Ç—Ä–∞–¥–∞—Ç—å? –ù–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞:</span>
          <button class="reset-btn" id="resetBtn">–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        </div>
      </div>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div class="panel right">
      <div class="slot" id="slotBox">
        <div class="reels" id="reels"></div>

        <div class="controls">
          <div class="betbox">
            <div class="bet-ctrl">
              <button class="step" id="betMinus">‚àí</button>
              <button class="step" id="betPlus">+</button>
            </div>
            <input type="range" class="bet-slider" id="bet" min="5" max="100" step="5"/>
          </div>

          <button id="spinBtn" class="btn spin-big">–ö—Ä—É—Ç–∏—Ç—å</button>

          <div class="statbox">
            <button id="autoBtn" class="btn auto-btn">–ê–≤—Ç–æ—Å–ø–∏–Ω: –≤—ã–∫–ª</button>
            <span class="small">–¶–µ–ª—å: $10 000 –∏ –≤—ã–∫—É–ø –Ω—É–∂–Ω–æ–≥–æ –¥–æ–±—Ä–∞</span>
          </div>
        </div>

        <div class="log" id="log"></div>
        <div class="footer">
          <div>–ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –æ–¥–∏–Ω ¬´–∞–ø–ø–µ–Ω–¥–∏–∫—Å¬ª ‚Äî –∑–∞–±–µ—Ä–∏ <b>–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</b> üíÄ</div>
          <div class="small">–°–∞—Ç–∏—Ä–∞. –ù–µ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∞.</div>
        </div>
        <div class="win-flash" id="winFlash"></div>
      </div>
    </div>
  </div>

  <!-- –ü–†–ê–í–ò–õ–ê -->
  <div class="modal-backdrop" id="rulesModal" style="display:none;align-items:center;justify-content:center;padding:14px;background:rgba(10,12,25,.65);position:fixed;inset:0">
    <div class="modal" style="width:min(560px,100%); background:linear-gradient(180deg,#1a1e45,#101334); border:1px solid #2b3161; border-radius:16px; box-shadow:var(--shadow); padding:18px">
      <h2>–í—ã–ø–ª–∞—Ç—ã –∏ —Å–∏–º–≤–æ–ª—ã</h2>
      <p class="small">–ö–æ–º–±–æ –ø–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏. –î–≤–µ üçí (—Å —É—á—ë—Ç–æ–º üí∏) ‚Äî –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏.</p>
      <div class="paytable" id="paytable" style="display:grid; grid-template-columns:1fr 1fr; gap:8px"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn auto-btn" id="rulesClose">–ü–æ–Ω—è—Ç–Ω–æ</button></div>
    </div>
  </div>

  <!-- –§–ò–ù–ê–õ –ü–†–û–ò–ì–†–´–®–ê -->
  <div class="modal-backdrop" id="gameOver" style="display:none;align-items:center;justify-content:center;padding:14px;background:rgba(10,12,25,.65);position:fixed;inset:0">
    <div class="modal" style="width:min(520px,100%); background:linear-gradient(180deg,#1a1e45,#101334); border:1px solid #2b3161; border-radius:16px; box-shadow:var(--shadow); padding:18px">
      <h2>–§–∏–Ω–∞–ª: ¬´–ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ–¥–µ–ø¬ª</h2>
      <p>–ò–≥–Ω–∞—Å–∏–æ —Ä–∞—Å–ø—Ä–æ–¥–∞–ª –≤—Å—ë, —Å–ª–æ—Ç –º–æ—Ä–≥–∞–µ—Ç –≤ –ø—É—Å—Ç–æ—Ç—É. –ù–∞—Å—Ç–æ—è—â–∏–π –∑–∞–Ω–æ—Å ‚Äî –Ω–∞–∂–∞—Ç—å –ø–∞—É–∑—É.</p>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn" id="restartBtn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button></div>
    </div>
  </div>

  <!-- –ü–û–ë–ï–î–ê -->
  <div class="modal-backdrop" id="winModal" style="display:none;align-items:center;justify-content:center;padding:14px;background:rgba(10,12,25,.65);position:fixed;inset:0">
    <div class="modal" style="width:min(560px,100%); background:linear-gradient(180deg,#1a1e45,#101334); border:1px solid #2b3161; border-radius:16px; box-shadow:var(--shadow); padding:18px">
      <h2>–ü–æ–±–µ–¥–∞! –ò–≥–Ω–∞—Å–∏–æ ‚Äî –∫–æ—Ä–æ–ª—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–æ–¥–µ–ø–∞</h2>
      <p>–¢—ã –Ω–∞–±—Ä–∞–ª $10 000 –∏ –≤—ã–∫—É–ø–∏–ª –æ–±—Ä–∞—Ç–Ω–æ –¥–æ–º, –∫–æ–º–ø—å—é—Ç–µ—Ä, –∞–ª—å—Ç—É—à–∫—É, –≤—Å—é –æ–¥–µ–∂–¥—É –∏ –≤—Å–µ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏. –ú–æ–∂–Ω–æ –∏ –≤ –ø–ª—é—Å —É–π—Ç–∏‚Ä¶ —Ö–æ—Ç—è –±—ã –º–æ—Ä–∞–ª—å–Ω–æ.</p>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn" id="winRestart">–ï—â—ë —Ä–∞–∑–æ–∫</button></div>
    </div>
  </div>

<script>
/* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã / –¥–∞–Ω–Ω—ã–µ ===== */
const STORAGE_KEY='last_dodep_save_ui_v2';

const SYMBOLS=[
  {id:'cherry',e:'üçí',weight:20,payout3:6,note:'–î–≤–µ üçí = 1√ó'},
  {id:'lemon', e:'üçã',weight:18,payout3:8},
  {id:'bell',  e:'üîî',weight:14,payout3:10},
  {id:'card',  e:'üí≥',weight:12,payout3:16},
  {id:'loan',  e:'üßæ',weight:9, payout3:24},
  {id:'chart', e:'üìà',weight:8, payout3:36},
  {id:'vault', e:'üè¶',weight:6, payout3:60},
  {id:'wild',  e:'üí∏',weight:4, payout3:100,note:'–ó–∞–º–µ–Ω—è–µ—Ç –ª—é–±–æ–π –æ–¥–∏–Ω'},
  {id:'jack',  e:'üßø',weight:1.2,payout3:380}
];

/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: property / clothing / limb / organ / misc (–¥–ª—è –ø–æ–±–µ–¥—ã —Å—á–∏—Ç–∞—é—Ç—Å—è: clothing, limb –∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ property) */
const INVENTORY_PRESET=[
  {id:'house',   icon:'üè†', title:'–î–æ–º',        cat:'property', value:[2500,3500]},
  {id:'car',     icon:'üöó', title:'–ú–∞—à–∏–Ω–∞',     cat:'property', value:[900,1400]},
  {id:'pc',      icon:'üíª', title:'–ö–æ–º–ø—å—é—Ç–µ—Ä',  cat:'property', value:[600,1000]},
  {id:'garage',  icon:'üèöÔ∏è',title:'–ì–∞—Ä–∞–∂',      cat:'property', value:[300,500]},
  {id:'altgirl', icon:'üßë‚Äçüé§',title:'–ö–∞—Ä—Ç–æ–Ω–Ω–∞—è ¬´–∞–ª—å—Ç—É—à–∫–∞ –∏–∑ —à–∫–∞—Ñ–∞¬ª', cat:'misc', value:[120,220]},
  {id:'jacket',  icon:'üß•', title:'–ö—É—Ä—Ç–∫–∞',     cat:'clothing', value:[80,140]},
  {id:'shirt',   icon:'üëï', title:'–§—É—Ç–±–æ–ª–∫–∞',   cat:'clothing', value:[40,90]},
  {id:'pants',   icon:'üëñ', title:'–®—Ç–∞–Ω—ã',      cat:'clothing', value:[70,130]},
  {id:'under',   icon:'ü©≤', title:'–¢—Ä—É—Å—ã',      cat:'clothing', value:[15,30]},
  {id:'hair',    icon:'üíá', title:'–í–æ–ª–æ—Å—ã',     cat:'misc',     value:[50,90]},
  {id:'armL',    icon:'‚úã',  title:'–õ–µ–≤–∞—è —Ä—É–∫–∞', cat:'limb',     value:[400,650]},
  {id:'armR',    icon:'ü§ö',  title:'–ü—Ä–∞–≤–∞—è —Ä—É–∫–∞',cat:'limb',     value:[400,650]},
  {id:'legL',    icon:'ü¶µ',  title:'–õ–µ–≤–∞—è –Ω–æ–≥–∞', cat:'limb',     value:[550,700]},
  {id:'legR',    icon:'ü¶ø',  title:'–ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞',cat:'limb',     value:[550,700]},
  {id:'eye',     icon:'üëÅÔ∏è', title:'–ì–ª–∞–∑',       cat:'organ',    value:[500,800]},
  {id:'kidney',  icon:'ü´Å', title:'–ü–æ—á–∫–∞',      cat:'organ',    value:[1500,2200]},
  {id:'liver',   icon:'ü´Ä', title:'–ß–∞—Å—Ç—å –ø–µ—á–µ–Ω–∏',cat:'organ',    value:[600,900]},
  {id:'appendix',icon:'üß´', title:'–ê–ø–µ–Ω–¥–∏–∫—Å',   cat:'organ',    value:[80,140]},
  {id:'stomach', icon:'ü´É', title:'–ñ–µ–ª—É–¥–æ–∫',    cat:'organ',    value:[400,700]},
  {id:'brain',   icon:'üß†', title:'–ú–æ–∑–≥',       cat:'organ',    value:[2000,3000]},
];

const START_BALANCE=500, MIN_BET=5, MAX_BET=100;
const GOAL_MONEY = 10000;

/* ===== –£—Ç–∏–ª–∏—Ç—ã ===== */
const $=s=>document.querySelector(s);
const rand=(a,b)=>Math.random()*(b-a)+a;
const randint=(a,b)=>Math.floor(rand(a,b+1));
const curFmt=new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0});
const fmt=n=>curFmt.format(n);
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function weightedPick(items, key='weight'){const total=items.reduce((s,i)=>s+i[key],0);let r=Math.random()*total;for(const it of items){if((r-=it[key])<=0)return it}return items[items.length-1]}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state))}
function load(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))}catch{return null}}

/* ===== –ó–≤—É–∫–∏ ===== */
class SFX{constructor(){this.ctx=null;this.enabled=true}init(){if(this.ctx)return;const AC=window.AudioContext||window.webkitAudioContext;if(AC)this.ctx=new AC()}toggle(v){this.enabled=v}osc(type,f,t,g){if(!this.enabled||!this.ctx)return;const o=this.ctx.createOscillator(),G=this.ctx.createGain();o.type=type;o.frequency.value=f;G.gain.value=g;o.connect(G);G.connect(this.ctx.destination);const now=this.ctx.currentTime;o.start(now);G.gain.exponentialRampToValueAtTime(.0001,now+t);o.stop(now+t+.02)}coin(){[880,1320,1760].forEach((f,i)=>setTimeout(()=>this.osc('square',f,.06,.09),i*60))}spin(){if(!this.enabled||!this.ctx)return;const o=this.ctx.createOscillator(),G=this.ctx.createGain();o.type='sawtooth';o.frequency.value=140;G.gain.value=.07;o.connect(G);G.connect(this.ctx.destination);const now=this.ctx.currentTime;o.start(now);G.gain.linearRampToValueAtTime(.0001,now+.8);o.frequency.exponentialRampToValueAtTime(55,now+.8);o.stop(now+.82)}win(){[523,659,784,1046].forEach((f,i)=>setTimeout(()=>this.osc('triangle',f,.1,.12),i*110))}thud(){this.osc('triangle',120,.15,.12)}sad(){if(!this.enabled||!this.ctx)return;const o=this.ctx.createOscillator(),G=this.ctx.createGain();o.type='sawtooth';o.frequency.value=220;G.gain.value=.08;o.connect(G);G.connect(this.ctx.destination);const now=this.ctx.currentTime;o.start(now);o.frequency.exponentialRampToValueAtTime(90,now+.6);G.gain.exponentialRampToValueAtTime(.0001,now+.65);o.stop(now+.7)}}
const sfx=new SFX();

/* ===== –û–∑–≤—É—á–∫–∞ (–≤–∫–ª/–≤—ã–∫–ª) ===== */
const TTS={enabled:false,voice:null,ensureReady(){if(!('speechSynthesis'in window))return false;const ss=speechSynthesis;const pick=()=>{const v=ss.getVoices();TTS.voice=v.find(x=>/^ru/i.test(x.lang))||v[0]||null};pick();if(!TTS.voice)ss.onvoiceschanged=pick;return true},speak(t){if(!TTS.enabled||!('speechSynthesis'in window))return;const u=new SpeechSynthesisUtterance(t);u.lang=(TTS.voice&&TTS.voice.lang)||'ru-RU';if(TTS.voice)u.voice=TTS.voice;u.rate=1;u.pitch=1;u.volume=1;speechSynthesis.speak(u)},cancel(){if('speechSynthesis'in window)speechSynthesis.cancel()}};

/* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
let state={
  balance: START_BALANCE,
  bet: 25,
  auto: false,
  inventory: [],
  wonTotal: 0,
  lostTotal: 0
};

/* ===== DOM ===== */
const balanceEl=$('#balance'), betEl=$('#bet'), betLabelEl=$('#betLabel');
const spinBtn=$('#spinBtn'), autoBtn=$('#autoBtn'), sfxToggle=$('#sfxToggle'), ttsToggle=$('#ttsToggle');
const reelsEl=$('#reels'), logEl=$('#log'), winFlashEl=$('#winFlash'), ignEl=$('#ignacio'), slotBox=$('#slotBox');
const invEl=$('#inventory'), invSummaryEl=$('#invSummary'), propsEl=$('#props');
const tabAvailable=$('#tabAvailable'), tabSold=$('#tabSold'), tabAll=$('#tabAll');
const rulesLink=$('#rulesLink'), rulesClose=$('#rulesClose'), rulesModal=$('#rulesModal');
const overModal=$('#gameOver'), restartBtn=$('#restartBtn'), resetBtn=$('#resetBtn');
const winModal=$('#winModal'), winRestart=$('#winRestart');
const betMinus=$('#betMinus'), betPlus=$('#betPlus');

/* ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const saved=load();
  if(saved){
    state={...state,...saved,wonTotal:saved.wonTotal||0,lostTotal:saved.lostTotal||0};
  }else{
    state.inventory=INVENTORY_PRESET.map(x=>({...x, price: randint(x.value[0],x.value[1]), sold:false}));
  }
  buildReels(); renderAll(); buildPaytable();
});

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
function renderAll(){ renderStats(); renderInventory(currentFilter); renderHero(); }
function renderStats(){
  balanceEl.textContent=fmt(state.balance);
  betEl.value=clamp(state.bet,MIN_BET,MAX_BET);
  betLabelEl.textContent=fmt(state.bet);
  spinBtn.disabled=state.bet>state.balance;
  autoBtn.textContent=`–ê–≤—Ç–æ—Å–ø–∏–Ω: ${state.auto?'–≤–∫–ª':'–≤—ã–∫–ª'}`;
}
let currentFilter='available';
function renderInventory(filter='available'){
  currentFilter=filter; invEl.innerHTML='';
  const items=state.inventory, available=items.filter(i=>!i.sold), sold=items.filter(i=>i.sold);
  invSummaryEl.textContent=`–î–æ—Å—Ç—É–ø–Ω–æ –∫ –¥–µ–ø—É: ${available.length} ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${items.length-sold.length}/${items.length}`;
  let list=items; if(filter==='available') list=available; if(filter==='sold') list=sold;

  const rec=available.length?available.reduce((a,b)=>a.price>b.price?a:b).id:null;

  list.forEach(it=>{
    const row=document.createElement('div'); row.className='item'+(it.sold?' gone':'');
    const icon=document.createElement('div'); icon.textContent=it.icon; icon.style.fontSize='20px';
    const txt=document.createElement('div');
    txt.innerHTML=`<b>${it.title}</b>${(!it.sold&&it.id===rec)?' ‚Ä¢ <span class="small" style="color:#a7ffcf">—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º</span>':''}
                   <div class="small">${it.sold? '–ü—Ä–æ–¥–∞–Ω–æ' : '–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å'}</div>`;
    const btn=document.createElement('div'); // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫
    if(!it.sold){
      const sell=document.createElement('button'); sell.className='dep'; sell.textContent=`–î–µ–ø–Ω—É—Ç—å +${fmt(it.price)}`; sell.addEventListener('click',()=>dep(it.id));
      btn.appendChild(sell);
    }else{
      if(canBuyback(it)){ const cost=buybackCost(it); const buy=document.createElement('button'); buy.className='buy'; buy.textContent=`–í—ã–∫—É–ø–∏—Ç—å –∑–∞ ${fmt(cost)}`; buy.disabled=state.balance<cost; buy.addEventListener('click',()=>buyback(it.id)); btn.appendChild(buy); }
      else{ const dash=document.createElement('button'); dash.className='dep'; dash.textContent='‚Äî'; dash.disabled=true; btn.appendChild(dash); }
    }
    row.append(icon, txt, btn); invEl.appendChild(row);
  });

  [tabAvailable,tabSold,tabAll].forEach(b=>b.classList.remove('active'));
  if(filter==='available') tabAvailable.classList.add('active');
  else if(filter==='sold') tabSold.classList.add('active'); else tabAll.classList.add('active');
}
function renderHero(){
  propsEl.innerHTML='';
  state.inventory.forEach(it=>{
    const tag=document.createElement('div'); tag.className='prop'+(it.sold?' sold':''); tag.textContent=`${it.icon} ${it.title}`;
    propsEl.appendChild(tag);
  });
  const lost=state.inventory.filter(i=>i.sold).length;
  ignEl.classList.remove('win','lose');
  ignEl.textContent = lost===0?'üòê' : lost<4?'üôÇ' : lost<8?'üò¨' : lost<12?'üòµ‚Äçüí´' : lost<16?'ü•¥' : 'ü´†';
}

/* ===== –†—ë–ª—ã ===== */
function buildReels(){
  reelsEl.innerHTML='';
  for(let i=0;i<3;i++){
    const reel=document.createElement('div'); reel.className='reel';
    const strip=document.createElement('div'); strip.className='strip';
    for(let k=0;k<3;k++){ const s=weightedPick(SYMBOLS); const c=document.createElement('div'); c.className='cell'; c.textContent=s.e; strip.appendChild(c); }
    reel.appendChild(strip); reelsEl.appendChild(reel);
  }
}

/* ===== –õ–æ–≥ ===== */
function putLog(text){ const p=document.createElement('p'); p.textContent=text; logEl.prepend(p); trimLog(); }
function putLogHTML(html){ const p=document.createElement('p'); p.className='post'; p.innerHTML=html; logEl.prepend(p); trimLog(); }
function trimLog(){ while(logEl.children.length>40) logEl.removeChild(logEl.lastChild); }

/* ===== –§—Ä–∞–∑—ã –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ ===== */
const SELL_LINES={
  house:a=>`–ò–≥–Ω–∞—Å–∏–æ –∑–∞–ª–æ–∂–∏–ª –¥–æ–º ‚Äî –æ—Ç–æ–ø–ª–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å —é–º–æ—Ä–æ–º. +${fmt(a)} –∫ –±–∞–Ω–∫—É.`,
  car:a=>`–ü—Ä–æ–¥–∞–ª –º–∞—à–∏–Ω—É: –ø–µ—à–∫–æ–º –¥–æ –∫–∞—Å—Å—ã –±–ª–∏–∂–µ. +${fmt(a)} –Ω–∞ –¥–æ–¥–µ–ø.`,
  pc:a=>`–ö–æ–º–ø ‚Äî –≤ –ª–æ–º–±–∞—Ä–¥. –°—Ç—Ä–∏–º–∏—Ç—å –±—É–¥–µ–º —É–¥–∞—á—É. +${fmt(a)}.`,
  garage:a=>`–ì–∞—Ä–∞–∂ —É–µ—Ö–∞–ª –∫ –Ω–æ–≤–æ–º—É –≤–ª–∞–¥–µ–ª—å—Ü—É. +${fmt(a)}.`,
  altgirl:a=>`–ê–ª—å—Ç—É—à–∫–∞ –∏–∑ —à–∫–∞—Ñ–∞ –Ω–∞—à–ª–∞ –Ω–æ–≤—ã–π –¥–æ–º. +${fmt(a)}.`,
  jacket:a=>`–ö—É—Ä—Ç–∫–∞ —É—à–ª–∞ —Å –º–æ–ª–æ—Ç–∫–∞. +${fmt(a)} ‚Äî —Å–æ–≥—Ä–µ–µ–º –±–∞–ª–∞–Ω—Å.`,
  shirt:a=>`–§—É—Ç–±–æ–ª–∫–∞ –≤ –Ω–æ–ª—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî –≤ –ø–ª—é—Å. +${fmt(a)}.`,
  pants:a=>`–®—Ç–∞–Ω—ã —Å–Ω—è—Ç—ã —á–µ—Å—Ç–Ω–æ. +${fmt(a)} –∫ –∫–∞–ø–∏—Ç–∞–ª—É.`,
  under:a=>`–ú–∏–Ω—É—Å —Ç—Ä—É—Å—ã, –ø–ª—é—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å. +${fmt(a)}.`,
  hair:a=>`–ü–∞—Ä–∏–∫–º–∞—Ö–µ—Ä –ª–∏–∫–æ–≤–∞–ª ‚Äî –±–∞–ª–∞–Ω—Å —Ç–æ–∂–µ. +${fmt(a)}.`,
  armL:a=>`–õ–µ–≤–∞—è —Ä—É–∫–∞ –ø—Ä–æ–¥–∞–Ω–∞. –ö–Ω–æ–ø–∫—É ¬´–ö—Ä—É—Ç–∏—Ç—å¬ª –∂–º—ë–º –ø—Ä–∞–≤–æ–π. +${fmt(a)}.`,
  armR:a=>`–ü—Ä–∞–≤–∞—è —Ä—É–∫–∞ —É—à–ª–∞. –•–æ—Ä–æ—à–æ, —á—Ç–æ –∞–≤—Ç–æ—Å–ø–∏–Ω –µ—Å—Ç—å. +${fmt(a)}.`,
  legL:a=>`–õ–µ–≤–∞—è –Ω–æ–≥–∞ ‚Äî –≤ –±—é–¥–∂–µ—Ç. +${fmt(a)}.`,
  legR:a=>`–ü—Ä–∞–≤–∞—è –Ω–æ–≥–∞ ‚Äî —Ç–æ–∂–µ –∞–∫—Ç–∏–≤. +${fmt(a)}.`,
  eye:a=>`–ú–∏–Ω—É—Å –≥–ª–∞–∑, –∑–∞—Ç–æ –≤–∏–¥–∏–º —Ç–æ–ª—å–∫–æ –∑–µ–ª—ë–Ω—ã–µ —Ü–∏—Ñ—Ä—ã. +${fmt(a)}.`,
  kidney:a=>`–ü–æ—á–∫–∞ ‚Äî —ç—Ç–æ –¥–≤–µ –ø–æ–ª–æ–≤–∏–Ω—ã –±–∞–Ω–∫—Ä–æ–ª–ª–∞. +${fmt(a)}.`,
  liver:a=>`–ß–∞—Å—Ç—å –ø–µ—á–µ–Ω–∏ –≤–∑—è—Ç–∞ –ø–æ–¥ –ø—Ä–æ—Ü–µ–Ω—Ç—ã. +${fmt(a)}.`,
  appendix:a=>`–ê–ø–µ–Ω–¥–∏–∫—Å? –ù–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ç–∏–≤. +${fmt(a)}.`,
  stomach:a=>`–ñ–µ–ª—É–¥–æ–∫ –ø—Ä–æ–¥–∞–Ω: –≥–æ–ª–æ–¥–∞—Ç—å –Ω–µ –±—É–¥–µ–º ‚Äî –±—É–¥–µ–º –∑–∞–Ω–æ—Å–∏—Ç—å. +${fmt(a)}.`,
  brain:a=>`–ú–æ–∑–≥ –Ω–∞ –ø–∞—É–∑–µ, —É–¥–∞—á–∞ ‚Äî –≤ —Ä–µ–π–∑–µ. +${fmt(a)}.`
};

/* ===== –í—Å–ø–æ–º–æ–≥ / —Å–µ—Å—Å–∏—è ===== */
function sessionStamp(){
  const net = state.wonTotal - state.lostTotal;
  const netStr = `${net>=0?'+':''}${fmt(Math.abs(net))}`;
  return `–°–µ—Å—Å–∏—è: –≤—ã–∏–≥—Ä–∞–Ω–æ ${fmt(state.wonTotal)} ‚Ä¢ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ ${fmt(state.lostTotal)} ‚Ä¢ –Ω–µ—Ç—Ç–æ ${netStr}`;
}

/* ===== –°–ø–∏–Ω ===== */
let spinning=false;
function roll(){ return weightedPick(SYMBOLS); }
function analyze(line){
  const ids=line.map(s=>s.id), em=line.map(s=>s.e), wilds=ids.filter(x=>x==='wild').length;
  for(const b of SYMBOLS){ if(b.id==='wild') continue; const c=ids.filter(x=>x===b.id).length; if(c>=3) return {win:true,mult:b.payout3,label:`${b.e}${b.e}${b.e}`,line:em}; }
  for(const b of SYMBOLS){ if(b.id==='wild') continue; const c=ids.filter(x=>x===b.id).length + wilds; if(c>=3) return {win:true,mult:b.payout3,label:`${b.e}${b.e}${b.e} (—Å üí∏)`,line:em}; }
  const ch=ids.filter(x=>x==='cherry').length + wilds; if(ch>=2) return {win:false,small:true,line:em};
  return {win:false,line:em};
}
async function spin(){
  if(spinning) return;
  slotBox.classList.remove('win-sticky'); // —É–±—Ä–∞—Ç—å –ø—Ä–æ—à–ª—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É

  if(state.bet>state.balance){ putLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –î–µ–ø–Ω–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å‚Ä¶ –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å üò∂‚Äçüå´Ô∏è'); sfx.sad(); TTS.speak('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ú–æ–∂–µ—Ç, —Ö–≤–∞—Ç–∏—Ç?'); return; }

  spinning=true;
  const wager = state.bet;
  state.balance -= wager; renderStats(); save(); sfx.init(); sfx.spin(); TTS.cancel();

  const res=[]; const reels=[...document.querySelectorAll('.reel')];
  for(let i=0;i<reels.length;i++){
    const reel=reels[i]; const old=reel.querySelector('.strip');
    const target=[roll(),roll(),roll()]; res.push(target[1]);
    const strip=document.createElement('div'); strip.className='strip';
    for(let k=0;k<15;k++){ const s=weightedPick(SYMBOLS); const c=document.createElement('div'); c.className='cell'; c.textContent=s.e; strip.appendChild(c); }
    target.forEach(s=>{ const c=document.createElement('div'); c.className='cell'; c.textContent=s.e; strip.appendChild(c); });
    old.replaceWith(strip);
    const cellH=strip.querySelector('.cell').offsetHeight, reelH=reel.clientHeight;
    const distance=(strip.children.length*cellH)-reelH;
    await animateY(strip, -Math.round(distance), 520+i*160);
  }

  const outcome=analyze(res);
  const lineTxt=`–õ–∏–Ω–∏—è: ${outcome.line.join(' | ')}`;

  if(outcome.win){
    const amount=Math.floor(wager*outcome.mult);
    state.balance+=amount; state.wonTotal += amount; renderStats(); save();
    winFlashEl.classList.add('show'); setTimeout(()=>winFlashEl.classList.remove('show'),600);
    slotBox.classList.add('win-sticky');
    ignEl.classList.add('win'); sfx.win();
    putLog(`${lineTxt} ‚Ä¢ –ö–æ–º–±–æ: ${outcome.label} ‚Ä¢ –í—ã–∏–≥—Ä—ã—à: ${fmt(amount)} ‚Ä¢ ${sessionStamp()}`);
    TTS.speak(`–ó–∞–Ω–æ—Å! ${amount} –¥–æ–ª–ª–∞—Ä–æ–≤`);
  } else if(outcome.small){
    state.balance += wager; renderStats(); save();
    ignEl.classList.add('win'); sfx.osc('square',660,.07,.09);
    putLog(`${lineTxt} ‚Ä¢ –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏ ‚Ä¢ ${sessionStamp()}`);
    TTS.speak('–í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏');
  } else {
    state.lostTotal += wager; renderStats(); save();
    ignEl.classList.add('lose'); sfx.thud();
    const phrase=randomQuote();
    putLog(`${lineTxt} ‚Ä¢ –ü—Ä–æ–∏–≥—Ä—ã—à: -${fmt(wager)} ‚Ä¢ ${sessionStamp()} ‚Ä¢ ${phrase}`);
    TTS.speak(phrase);
  }

  spinning=false;
  checkVictory();

  if(state.balance<state.bet){
    const next=state.inventory.find(i=>!i.sold);
    if(next){ putLog(`–ù—É–∂–µ–Ω –¥–µ–ø: ${next.icon} ${next.title} –∑–∞ +${fmt(next.price)}.`); TTS.speak(`–ü—Ä–æ–¥–∞–π ${next.title}`); sfx.sad(); }
    else showGameOver();
  }
  if(state.auto&&!spinning) setTimeout(spin,420);
}
function animateY(el,to,d=600){return new Promise(res=>{const s=performance.now(),from=0;function step(t){const p=Math.min(1,(t-s)/d),e=1-Math.pow(1-p,3),y=Math.round(from+(to-from)*e);el.style.transform=`translate3d(0,${y}px,0)`;if(p<1)requestAnimationFrame(step);else res()}requestAnimationFrame(step)})}

/* ===== –§—Ä–∞–∑—ã / –¥–µ–ø—ã / –≤—ã–∫—É–ø ===== */
const QUOTES=['–ü–∞—Ü–∞–Ω—ã, –Ω–µ —Ö–æ–º—è–∫–∏ ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.','–ï—â—ë –æ–¥–∏–Ω –¥–µ–ø ‚Äî –∏ —Ç–æ—á–Ω–æ –≤—ã—Ö–æ–∂—É.','–§–∞—Ä—Ç –ø–∞—Ö–Ω–µ—Ç –º–∏–∫—Ä–æ–∑–∞–π–º–æ–º.','–ë–µ–∑ —à—Ç–∞–Ω–æ–≤ –∫—Ä—É—Ç–∏—Ç—Å—è –ª–µ–≥—á–µ.','–õ–µ–≤–∞—è –ø–æ—á–∫–∞ ‚Äî –Ω–µ –æ—Å–Ω–æ–≤–Ω–∞—è.','–û–∫—É–ø–∏–ª—Å—è! –ü–æ–∫–∞ –≤ —Ç–µ–æ—Ä–∏–∏.','–ë–∞–Ω–∫—Ä–æ–ª–ª –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç? –°–ª—ã—à–∞–ª –∫—Ä–∞–µ–º –ø–µ—á–µ–Ω–∏.','–ö–Ω–æ–ø–∫–∞ —Å–∞–º–∞ –ø—Ä–æ—Å–∏—Ç.'];
function randomQuote(){return QUOTES[Math.floor(Math.random()*QUOTES.length)]}

function dep(id){
  const it=state.inventory.find(x=>x.id===id); if(!it||it.sold) return;
  it.sold=true; state.balance += it.price; sfx.coin();
  putLog( SELL_LINES[it.id] ? SELL_LINES[it.id](it.price) : `–ü—Ä–æ–¥–∞–Ω–æ: ${it.title}. +${fmt(it.price)}.` );
  renderInventory(currentFilter); renderStats(); renderHero(); save();
  checkVictory();
}

function canBuyback(it){ return it.cat!=='organ'; } // –æ—Ä–≥–∞–Ω—ã –≤—ã–∫—É–ø–∏—Ç—å –Ω–µ–ª—å–∑—è
function buybackCost(it){
  // –æ–¥–µ–∂–¥–∞ ‚Äî –º—è–≥–∫–∏–π –Ω–∞—Ü–µ–Ω–∫–∞ 10%, property/limb/misc ‚Äî 35%
  const k = it.cat==='clothing' ? 1.10 : 1.35;
  return Math.ceil(it.price * k);
}
function buyback(id){
  const it=state.inventory.find(x=>x.id===id); if(!it||!it.sold) return;
  if(!canBuyback(it)) return;
  const cost = buybackCost(it);
  if(state.balance < cost){ putLog(`–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ –≤—ã–∫—É–ø ${it.title}. –ù—É–∂–Ω–æ ${fmt(cost)}.`); return; }
  state.balance -= cost; it.sold=false; sfx.coin();
  putLog(`–í—ã–∫—É–ø–∏–ª–∏: ${it.title} –∑–∞ ${fmt(cost)}. –ë–∞–ª–∞–Ω—Å —Å–Ω–æ–≤–∞ –∑–Ω–∞–µ—Ç —Å—Ç–∏–ª—å.`);
  renderInventory(currentFilter); renderStats(); renderHero(); save();
  checkVictory();
}

/* ===== –ü–æ–±–µ–¥–∞ / —Ñ–∏–Ω–∞–ª—ã / —Å–±—Ä–æ—Å ===== */
function needForVictory(){
  // —Å–ø–∏—Å–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫ –≤—ã–∫—É–ø—É
  const needIds = ['house','pc','altgirl','jacket','shirt','pants','under','armL','armR','legL','legR'];
  return needIds.map(id=>state.inventory.find(x=>x.id===id));
}
function victoryAchieved(){
  const must = needForVictory();
  const allBack = must.every(x=>x && !x.sold);
  return state.balance >= GOAL_MONEY && allBack;
}
function checkVictory(){ if(victoryAchieved()) { winModal.style.display='flex'; state.auto=false; } }

function showRules(){rulesModal.style.display='flex'}
function hideRules(){rulesModal.style.display='none'}
function showGameOver(){overModal.style.display='flex'; state.auto=false; renderStats()}
function hardReset(){
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) return;
  localStorage.removeItem(STORAGE_KEY);
  state={
    balance: START_BALANCE, bet: 25, auto:false,
    inventory: INVENTORY_PRESET.map(x=>({...x, price: randint(x.value[0],x.value[1]), sold:false})),
    wonTotal:0, lostTotal:0
  };
  buildReels(); renderAll(); buildPaytable(); putLog('–ü—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω—É–ª–µ–Ω—ã.');
}

/* ===== –°–æ–±—ã—Ç–∏—è ===== */
spinBtn.addEventListener('click', ()=>{ sfx.init(); spin(); });
autoBtn.addEventListener('click', ()=>{ sfx.init(); state.auto=!state.auto; renderStats(); save(); if(state.auto) spin(); });
betEl.addEventListener('input', e=>{ state.bet=clamp(parseInt(e.target.value,10)||MIN_BET, MIN_BET, MAX_BET); renderStats(); save(); });
$('#betMinus').addEventListener('click', ()=>{ state.bet=clamp(state.bet-5, MIN_BET, MAX_BET); betEl.value=state.bet; renderStats(); save(); });
$('#betPlus').addEventListener('click', ()=>{ state.bet=clamp(state.bet+5, MIN_BET, MAX_BET); betEl.value=state.bet; renderStats(); save(); });

sfxToggle.addEventListener('change', e=> sfx.toggle(e.target.checked));
ttsToggle.addEventListener('change', e=> { TTS.enabled = e.target.checked && TTS.ensureReady(); if(TTS.enabled) TTS.speak('–û–∑–≤—É—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞'); });

$('#tabAvailable').addEventListener('click', ()=> renderInventory('available'));
$('#tabSold').addEventListener('click', ()=> renderInventory('sold'));
$('#tabAll').addEventListener('click', ()=> renderInventory('all'));

rulesLink.addEventListener('click', showRules);
rulesClose.addEventListener('click', hideRules);
restartBtn.addEventListener('click', ()=>{ hardReset(); overModal.style.display='none'; });
winRestart.addEventListener('click', ()=>{ hardReset(); winModal.style.display='none'; });
resetBtn.addEventListener('click', hardReset);

document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); sfx.init(); spin(); } });

/* ===== –ü—ç–π—Ç–µ–π–±–ª ===== */
function buildPaytable(){
  const wrap=$('#paytable'); wrap.innerHTML='';
  SYMBOLS.forEach(s=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;background:#111537;border:1px solid #2c3262;border-radius:10px;padding:6px 8px';
    row.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><span style="font-size:22px">${s.e}</span> √ó3</div><div><b>${s.payout3}√ó</b> <span class="small">${s.note||''}</span></div>`;
    wrap.appendChild(row);
  });
}
</script>
</body>
</html>
