<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ù–µ–±–æ –¥–ª—è —Ç–µ–±—è</title>
<style>
  :root{ --bg:#0b1020; --fg:#e8ecff; --muted:#a7b0d0; --card:#11162a; --line:#2a375f; --accent:#9ecbff; }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f8ff; --fg:#101326; --muted:#3b4260; --card:#ffffff; --line:#cdd6ff; --accent:#3a6ee8; }
    body{ background: linear-gradient(180deg,#e8edff 0%,#f6f8ff 60%,#ffffff 100%) }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    background: radial-gradient(1200px 800px at 70% -10%, #1a2050 0%, var(--bg) 40%, #060812 90%);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    overflow:hidden;
  }
  canvas#sky{ position:fixed; left:0; top:0; width:100vw; height:100vh; display:block; z-index:0; }

  .ui{
    position:fixed; left:16px; right:16px; top:12px; z-index:3;
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    background: rgba(10,15,30,.45);
    border:1px solid rgba(100,120,180,.35);
    border-radius:14px; padding:10px 12px; backdrop-filter: blur(6px);
  }
  .pill{display:inline-flex; align-items:center; gap:10px; padding:6px 10px; border:1px solid rgba(100,120,180,.35); border-radius:999px; background: rgba(17,22,42,.7)}
  .bar{--p:0%; width:160px; height:8px; border-radius:999px; background:#1b2140; overflow:hidden; border:1px solid rgba(100,120,180,.35)}
  .bar>i{display:block; height:100%; width:var(--p); background:linear-gradient(90deg,#7fb4ff,#a3d3ff)}
  .btn{cursor:pointer; border:1px solid rgba(100,120,180,.35); background: rgba(17,22,42,.85); padding:6px 12px; border-radius:10px; color:var(--fg)}
  .btn:active{transform:scale(.98)}

  .panel{
    position:fixed; right:16px; top:72px; z-index:2;
    width: min(440px, calc(100vw - 32px));
    background: rgba(10,15,30,.45);
    border:1px solid rgba(100,120,180,.35);
    border-radius:16px; padding:14px; backdrop-filter: blur(6px);
  }
  .card{background: rgba(17,22,42,.85); border:1px solid rgba(100,120,180,.35); border-radius:14px; padding:12px 14px; color:var(--fg)}
  .card h3{margin:0 0 6px; font-size:16px}
  .card p{margin:0; color:var(--muted)}
  .constellations{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px}
  .badge{
    display:flex; align-items:center; gap:10px; padding:10px; border:1px dashed rgba(100,120,180,.5);
    border-radius:12px; background: rgba(17,22,42,.9); cursor:pointer; color:var(--fg)
  }
  .badge.locked{opacity:.65; filter:grayscale(.2)}
  .badge i{width:10px; height:10px; border-radius:999px; background:#9ecbff; box-shadow:0 0 12px rgba(158,203,255,.55), 0 0 32px rgba(158,203,255,.22)}
  .hint{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); z-index:3; color:var(--muted); background: rgba(10,15,30,.55); border:1px solid rgba(100,120,180,.35); border-radius:12px; padding:10px 14px}
  .modal{position:fixed; inset:0; display:none; place-items:center; padding:20px; z-index:5; background: rgba(3,6,14,.55); backdrop-filter: blur(6px)}
  .modal.show{display:grid}
  .sheet{width:min(600px,92vw); background: rgba(17,22,42,.95); color:var(--fg); border:1px solid rgba(100,120,180,.35); border-radius:16px; padding:18px}
  .sheet h2{margin:0 0 10px}
  .sheet p{margin:.35em 0; color:var(--muted)}
  .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .a{cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid rgba(100,120,180,.35); background: rgba(17,22,42,.9); color:var(--fg)}
  .a.primary{background:linear-gradient(90deg,#7fb4ff,#a3d3ff); color:#0b1020; border:none}
  .toast{position:fixed; left:50%; top:18px; transform:translateX(-50%); z-index:6; padding:8px 12px; background: rgba(17,22,42,.95); border:1px solid rgba(100,120,180,.35); border-radius:10px; display:none}
  .toast.show{display:block}
  .signature{position:fixed; right:18px; bottom:18px; color:var(--muted); font-size:12px; z-index:3; opacity:.85}

  /* –º–∏–Ω–∏-—Å—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ —Ç—Ä–µ–∫–æ–≤ */
  .tracks{margin-top:10px; padding:10px; border:1px dashed rgba(100,120,180,.45); border-radius:12px; background: rgba(10,15,30,.35)}
  .track{margin:.6em 0}
  .track strong{display:block; margin-bottom:4px}
  audio{width:100%; outline:none}
  @media (max-width:640px){ .panel{left:16px; right:16px; top:auto; bottom:72px} .ui{left:12px; right:12px; bottom:12px; top:auto} }
</style>
</head>
<body>
<canvas id="sky" aria-label="–∑–≤—ë–∑–¥–Ω–æ–µ –Ω–µ–±–æ" role="img"></canvas>

<div class="ui" aria-live="polite">
  <span class="pill">‚ú® –°–≤–µ—Ç: <strong id="lightCount">0</strong>/<span id="lightGoal">36</span>
    <span class="bar"><i id="lightBar" style="--p:0%"></i></span>
  </span>
  <button class="btn" id="soundBtn" aria-pressed="false">üîï –ó–≤—É–∫: –≤—ã–∫–ª</button>
  <button class="btn" id="resetBtn">‚ôªÔ∏é –°–±—Ä–æ—Å</button>
</div>

<div class="panel" id="panel" aria-label="–ø–∞–Ω–µ–ª—å —Å–æ–∑–≤–µ–∑–¥–∏–π">
  <div class="card">
    <h3>–°–æ–∑–≤–µ–∑–¥–∏—è –ø—Ä–∏–∑–Ω–∞–Ω–∏–π</h3>
    <p>–û—Ç–∫—Ä—ã–≤–∞–π –ø–æ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –≤ –∫–∞–∂–¥–æ–º —Å–ø—Ä—è—Ç–∞–Ω—ã –Ω–µ–±–æ–ª—å—à–∏–µ –ø–æ—Å–ª–∞–Ω–∏—è.</p>
  </div>
  <div class="constellations" id="constList"></div>
</div>

<div class="hint">–ö–∞—Å–∞–π—Å—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –∑–≤—ë–∑–¥ ‚Äî —Å–æ–±–∏—Ä–∞–π —Å–≤–µ—Ç, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Å–æ–∑–≤–µ–∑–¥–∏—è.</div>

<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <h2 id="mTitle">–°–æ–∑–≤–µ–∑–¥–∏–µ</h2>
    <div id="mText"></div>
    <div class="actions">
      <button class="a" id="close">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="a primary" id="continue">–î–∞–ª—å—à–µ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status">–°–æ–∑–≤–µ–∑–¥–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ ‚ú®</div>
<div class="signature">—Å–¥–µ–ª–∞–Ω–æ —Å —Ç–µ–ø–ª–æ–º –æ—Ç –∫–æ—Ç–æ–º—É–∂–∞</div>

<script>
(()=>{
// ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ (—É–∫–∞–∂–∏ —Å–≤–æ–∏ —Å—Å—ã–ª–∫–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è) ======
const FINAL_TRACKS = [
  { title: "–ù–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ", url: "https://shoooperd.github.io/gpt/eng.mp3" },
  { title: "–ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ –Ω–µ–º–Ω–æ–≥–æ –∫—Ä–∏–≤–æ",        url: "https://shoooperd.github.io/gpt/ru.mp3" }
];
// –ü–æ–¥—Å–∫–∞–∑–∫–∞: –¥–ª—è GitHub –∏—Å–ø–æ–ª—å–∑—É–π raw-—Å—Å—ã–ª–∫—É –≤–∏–¥–∞
// https://raw.githubusercontent.com/<user>/<repo>/<branch>/folder/file.mp3
// –∏–ª–∏ –¥–æ–±–∞–≤—å ?raw=1 –∫ –æ–±—ã—á–Ω–æ–º—É URL —Ñ–∞–π–ª–∞ –Ω–∞ GitHub.

// ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ =====
const STORAGE_KEY = "stargame_audio_v1";
const state = { light:0, unlocked:[], sound:false };
const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||"null"); if(saved) Object.assign(state, saved);
const save = ()=> localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

// ===== –ê—É–¥–∏–æ-–ø–∏–Ω–≥ =====
let audioCtx=null;
function ping(){
  if(!state.sound) return;
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type="sine"; o.frequency.value = 820 + Math.random()*200; g.gain.value=0.0001;
  o.connect(g); g.connect(audioCtx.destination);
  const t = audioCtx.currentTime; o.start();
  g.gain.exponentialRampToValueAtTime(0.06, t+0.04);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.25);
  o.stop(t+0.28);
}

// ===== –ö–∞–Ω–≤–∞—Å + DPI =====
const canvas = document.getElementById('sky');
const ctx = canvas.getContext('2d');
let W=0,H=0,DPR=1;
function fitCanvas(){
  W = Math.max(1, Math.floor(window.innerWidth));
  H = Math.max(1, Math.floor(window.innerHeight));
  DPR = Math.min(window.devicePixelRatio || 1, 2);
  canvas.width  = Math.floor(W * DPR);
  canvas.height = Math.floor(H * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', fitCanvas, {passive:true}); fitCanvas();

// ===== –ó–≤—ë–∑–¥—ã =====
const STAR_COUNT = 240;
const stars = [];
const sparkles = [];
const palette = [
  { w:0.28, color:()=>`rgba(${rand(150,180)},${rand(190,220)},255,`, tw:1.15 },
  { w:0.40, color:()=>`rgba(222,230,255,`, tw:1.00 },
  { w:0.22, color:()=>`rgba(255,${rand(220,235)},${rand(145,175)},`, tw:0.95 },
  { w:0.10, color:()=>`rgba(255,${rand(180,205)},${rand(110,140)},`, tw:0.90 },
];
const palCum = (()=>{
  let a=0, out=[]; for(const p of palette){ a+=p.w; out.push(a); } return out;
})();
function pickPal(){ const r=Math.random(); for(let i=0;i<palCum.length;i++) if(r<palCum[i]) return palette[i]; return palette.at(-1); }
function rand(a,b){ return a + Math.random()*(b-a); }

function initStars(){
  stars.length = 0;
  for(let i=0;i<STAR_COUNT;i++){
    const pal = pickPal();
    stars.push({ x:Math.random()*W, y:Math.random()*H, z:Math.random(), r:Math.random()*1.5+0.35, tw:Math.random()*Math.PI*2, pal });
  }
}
initStars();

let mouse = {x:W/2,y:H/2};
function getLocalXY(evt){
  const rect = canvas.getBoundingClientRect();
  return { x:(evt.clientX ?? evt.x) - rect.left, y:(evt.clientY ?? evt.y) - rect.top };
}
addEventListener('mousemove', e=>{ mouse = getLocalXY(e); }, {passive:true});
addEventListener('touchmove', e=>{ if(e.touches[0]) mouse = getLocalXY(e.touches[0]); }, {passive:true});
canvas.addEventListener('click', e=> tryCollect(getLocalXY(e)));
canvas.addEventListener('touchstart', e=>{ if(e.touches[0]) tryCollect(getLocalXY(e.touches[0])); }, {passive:true});
function addSparkle(x,y){ sparkles.push({x,y,a:1,r:0}); }

function tryCollect(p){
  let best=-1, bestD2=Infinity;
  for(let i=0;i<stars.length;i++){
    const s=stars[i];
    const px = s.x + (mouse.x-W/2)*s.z*0.02;
    const py = s.y + (mouse.y-H/2)*s.z*0.02;
    const dx=p.x-px, dy=p.y-py, d2=dx*dx+dy*dy;
    const hitR=(s.r+6);
    if(s.r<1.9 && d2<hitR*hitR && d2<bestD2){ bestD2=d2; best=i; }
  }
  if(best>=0){
    const s=stars[best];
    addSparkle(p.x,p.y); addLight(1); ping();
    s.x=Math.random()*W; s.y=Math.random()*H; s.r=Math.random()*1.5+0.35; s.tw=Math.random()*Math.PI*2;
  }
}

function clearAll(){ ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.restore(); }
function draw(){
  clearAll();
  const g = ctx.createRadialGradient(W*0.7, -H*0.2, 0, W*0.7, -H*0.2, H*1.2);
  g.addColorStop(0,'rgba(60,70,150,0.25)'); g.addColorStop(1,'rgba(6,8,18,0)');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  ctx.lineWidth=0.4; ctx.strokeStyle='rgba(158,203,255,0.07)';
  for(let i=0;i<stars.length;i+=12){
    const s=stars[i], t=stars[(i+7)%stars.length];
    const sx=s.x+(mouse.x-W/2)*s.z*0.02, sy=s.y+(mouse.y-H/2)*s.z*0.02;
    const tx=t.x+(mouse.x-W/2)*t.z*0.02, ty=t.y+(mouse.y-H/2)*t.z*0.02;
    ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(tx,ty); ctx.stroke();
  }

  for(const s of stars){
    const px=s.x+(mouse.x-W/2)*s.z*0.02, py=s.y+(mouse.y-H/2)*s.z*0.02;
    s.tw += (0.02 + s.z*0.02)*s.pal.tw;
    const a = 0.7 + Math.sin(s.tw)*0.3;
    ctx.fillStyle = s.pal.color() + (0.25 + a*0.35) + ')';
    ctx.beginPath(); ctx.arc(px,py, s.r + a*0.55, 0, Math.PI*2); ctx.fill();
  }

  for(let i=sparkles.length-1;i>=0;i--){
    const sp=sparkles[i]; sp.r+=0.8; sp.a-=0.02;
    ctx.strokeStyle=`rgba(190,220,255,${sp.a})`; ctx.lineWidth=1.2;
    ctx.beginPath(); ctx.arc(sp.x,sp.y,sp.r,0,Math.PI*2); ctx.stroke();
    if(sp.a<=0) sparkles.splice(i,1);
  }
  requestAnimationFrame(draw);
}
draw();

// ===== UI / –ø—Ä–æ–≥—Ä–µ—Å—Å =====
const LIGHT_GOAL=36;
document.getElementById('lightGoal').textContent=LIGHT_GOAL;
const lightCountEl=document.getElementById('lightCount');
const lightBarEl=document.getElementById('lightBar');
function updateLightUI(){ lightCountEl.textContent=state.light; lightBarEl.style.setProperty('--p', Math.round(state.light/LIGHT_GOAL*100)+'%'); }
updateLightUI();
const toastEl=document.getElementById('toast'); let toastTimer=null;
function toast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove('show'),1800); }
const WHISPERS=["–û–π —Ö–∞–ª–∞—Å–æ —Ö–∞–ª–∞—Å–æ","–ú–∏—Å–∫–∞ —Ä–∏—Å –¥–ª—è –ö–æ—à–∫–∞–∂–µ–Ω–∞","–ö–∏—Ç–∞–π –ø–∞—Ä—Ç–∏—è –æ–¥–æ–±—Ä—è—Ç—å","–ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—Ç–æ-—Ç–æ –æ—Å—Ç—Ä–æ—É–º–Ω–æ–µ","–¢—ã - –ª—É—á—à–∞—è –∫–æ—à–∫–∞–∂–µ–Ω–∞","–ö–æ—Ç–æ–º—É–∂ –Ω–∞–µ–ª—Å—è –ø–∏—Ü—Ü—ã","–ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–∏–º —Å–≤–µ—Ä—Ö—ä–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ","–£–ª—ã–±–∞–π—Å—è –ø–æ—á–∞—â–µ"];
function addLight(n){ state.light=Math.min(LIGHT_GOAL,state.light+n); updateLightUI(); save(); maybeUnlock(); if(Math.random()<0.18) toast(WHISPERS[Math.floor(Math.random()*WHISPERS.length)]+" ‚ú®"); }

// ===== –°–æ–∑–≤–µ–∑–¥–∏—è =====
const CONSTS=[
  { id:'calm', name:'–ü–µ—Ä–≤–æ–µ', need:8,  text:["–Ø –ø–æ–º–Ω—é —Ç–æ—Ç –¥–µ–Ω—å –∫–æ–≥–¥–∞ —à—É—Ç–∫–∞ –Ω–∞ –ø–µ—Ä–≤—ã–π –≤–∑–≥–ª—è–¥ –æ–∫–∞–∑–∞–ª–∞—Å—å –Ω–∞—á–∞–ª–æ–º —á–µ–≥–æ-—Ç–æ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–æ–≤–æ–≥–æ –¥–ª—è –º–µ–Ω—è.","–Ø –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –Ω–µ –º–æ–≥ —á—Ç–æ –º–æ—è –∂–∏–∑–Ω—å –æ–±—Ä–µ—Ç—ë—Ç –Ω–∞—Å—Ç–æ–ª—å–∫–æ —Ç—ë–ø–ª—ã–µ –∏ –Ω–µ–∂–Ω—ã–µ –∫—Ä–∞—Å–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –º–Ω–µ –ø–æ–¥–∞—Ä–∏–ª–∞.","–¢–≤–æ–∏ —Å—é—Ä–ø—Ä–∏–∑—ã, –∑–∞–≥–∞–¥–∫–∏, –ø–æ–¥–∞—Ä–∫–∏ - –∑–∞—Å—Ç–∞–≤–ª—è–ª–∏ –º–æ—ë —Å–µ—Ä–¥—Ü–µ –±–∏—Ç—å—Å—è —á–∞—â–µ –∞ —É–ª—ã–±–∫—É –Ω–µ —Å—Ö–æ–¥–∏—Ç—å —Å –ª–∏—Ü–∞ –Ω–∏ –Ω–∞ –º–∏–Ω—É—Ç—É.","–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã–π –Ω–∞–º–∏ –≤–º–µ—Å—Ç–µ - –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç —ç—Ç–∏ –æ—â—É—â–µ–Ω–∏—è –≤—Å—ë —Å–∏–ª—å–Ω–µ–µ, –¥–µ–ª–∞—è –Ω–∞—Å –≤—Å—ë –±–ª–∏–∂–µ.","–°–ø–∞—Å–∏–±–æ –∑–∞ —ç—Ç–∏ —á—É–≤—Å—Ç–≤–∞, –º–æ—è –¥–æ—Ä–æ–≥–∞—è –∫–æ—à–∫–∞–∂–µ–Ω–∞!"]},
  { id:'interest', name:'–í—Ç–æ—Ä–æ–µ', need:10, text:["–Ø –æ–±–æ–∂–∞—é –≤—Å–µ–º —Å–µ—Ä–¥—Ü–µ–º —Ç–≤–æ—é —É–ª—ã–±–∫—É –∏ —Å–º–µ—Ö.","–ö–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è —Ç–≤–æ–π –≥–æ–ª–æ—Å –∫–æ–≥–¥–∞ —Ç—ã —á–∏—Ç–∞–µ—à—å —á—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –º–Ω–æ–π, —Å –ª–µ–≥–∫–∏–º–∏ –Ω–æ—Ç–∫–∞–º–∏ —Å–º—É—â–µ–Ω–∏—è.","–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, –∫–∞–∫ –Ω–∞—à–∏ –Ω–æ—á–Ω—ã–µ –±–µ—Å–µ–¥—ã –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —Å–∞–º–∏ —Å–æ–±–æ–π.","–í—Å–µ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ —Ö–æ—á–µ—Ç—Å—è —É–∑–Ω–∞–≤–∞—Ç—å —Ç–µ–±—è –≤—Å—ë –±–æ–ª—å—à–µ –∏ –±–æ–ª—å—à–µ.","–¢—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–µ–π—à–∞—è –º–æ—è –∫–æ—à–∫–∞–∂–µ–Ω–∞!"]},
  { id:'warmth', name:'–¢—Ä–µ—Ç—å–µ', need:9,  text:["–£ —Ç–µ–±—è –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –∫—Ä–∞—Å–∏–≤—ã–µ –≥–ª–∞–∑–∞, –ª–∏—á–∏–∫–æ, –≥—É–±—ã - –≤—Å—ë —ç—Ç–æ —è –±–µ–∑—É–º–Ω–æ –æ–±–æ–∂–∞—é¬ª.","–ü–æ—Ä–æ–π –º–Ω–µ —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –ª—é–±–æ–≤–∞—Ç—å—Å—è –º–æ–µ–π –∫–æ—à–∫–∞–∂–µ–Ω–æ–π –∏ —É–ª—ã–±–∞—Ç—å—Å—è.","–¢–≤–æ–π –≥–æ–ª–æ—Å –∏ —Å–º–µ—Ö - –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –º–æ–∏—Ö —É—à–µ–π, —Å–æ–≥—Ä–µ–≤–∞—é—â–∏–π –¥—É—à—É.","–ê —Ç–∞–∫–∂–µ - —É —Ç–µ–±—è –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –≤–∫—É—Å –≤ –º—É–∑—ã–∫–µ, –ø–æ–≤–µ–¥–∞—é –ø–æ —Å–µ–∫—Ä–µ—Ç—É!","–Ø –ø–∏—à—É —ç—Ç–æ —Å –∫—Ä–∞—Å–Ω—ã–º –∫–∞–∫ —Ç–æ–º–∞—Ç –ª–∏—Ü–æ–º, –ø–æ—ç—Ç–æ–º—É –Ω–µ–º–Ω–æ–≥–æ —Ç–µ—Ä—è—é—Å—å –ø–æ–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è—é —ç—Ç–æ –∞—Ö–∞—Ö."]},
  { id:'brave', name:'–ß–µ—Ç–≤—ë—Ä—Ç–æ–µ', need:9,  text:["–Ø –±–µ–∑—É–º–Ω–æ —Ä–∞–¥ –Ω–∞—à–µ–º—É –∑–Ω–∞–∫–æ–º—Å—Ç–≤—É –∏ —Ç–æ–º—É, –∫–∞–∫ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è –Ω–∞—à–∏ —á—É–≤—Å—Ç–≤–∞.","–Ø –≤–µ—Ä—é —á—Ç–æ —Ç–æ, —á—Ç–æ —Å–æ–∑–¥–∞–ª–æ—Å—å –º–µ–∂–¥—É –Ω–∞–º–∏ - –±—É–¥–µ—Ç –∏ –¥–∞–ª—å—à–µ —Ä–∞—Å—Ç–∏ –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –≤—Å—ë –∫—Ä–µ–ø—á–µ.","–ò –±—ã—Ç—å –º–æ–∂–µ—Ç –≤ –±—É–¥—É—â–µ–º –º—ã —Å–º–æ–∂–µ–º –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è –ª–∏—Ü–æ–º –∫ –ª–∏—Ü—É.","–ß—Ç–æ–±—ã —è –º–æ–≥ –æ–±–Ω—è—Ç—å —Ç–µ–±—è, –¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è –∑–∞ —Ä—É–∫—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –ª—é–±–∏–º—ã–µ –º–µ—Å—Ç–∞, –≤ –æ–±–Ω–∏–º–∫—É –ª–µ–∂–∞—Ç—å –∏ —Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å –≤–º–µ—Å—Ç–µ.","–°–ø–∞—Å–∏–±–æ —á—Ç–æ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏, –º–∏–ª–∞—è! –Ø —Ä–∞–¥ –æ—â—É—â–∞—Ç—å –∏ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —á—Ç–æ –≤–ª—é–±–∏–ª—Å—è –≤ —Ç–µ–±—è... –ü—É-–ø—É-–ø—É –∞—Ö–∞—Ö... –ù–∞–¥–µ—é—Å—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –º–æ–µ–≥–æ –ø–æ–¥–∞—Ä–∫–∞ —Ç–µ–±–µ —Ç–∞–∫–∂–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è!"]},
];
const constList=document.getElementById('constList');

function needBefore(id){ let sum=0; for(const c of CONSTS){ if(state.unlocked.includes(c.id)) continue; sum+=c.need; if(c.id===id) break; } return sum; }
function renderConstellations(){
  constList.innerHTML=''; for(const c of CONSTS){
    const unlocked=state.unlocked.includes(c.id); const enough=state.light>=needBefore(c.id);
    const el=document.createElement('div'); el.className='badge'+(unlocked?'':' locked');
    el.innerHTML=`<i></i><div><strong>${c.name}</strong><div style="color:var(--muted); font-size:12px">${unlocked?'–æ—Ç–∫—Ä—ã—Ç–æ':(enough?'–≥–æ—Ç–æ–≤–æ –æ—Ç–∫—Ä—ã—Ç—å':'–∫–ª–∏–∫–∞–π –ø–æ –∑–≤–µ–∑–¥–∞–º')}</div></div>`;
    el.addEventListener('click',()=>tryOpenConstellation(c)); constList.appendChild(el);
  }
}
renderConstellations();

const modal=document.getElementById('modal');
const mTitle=document.getElementById('mTitle');
const mText=document.getElementById('mText');
document.getElementById('close').onclick=()=>modal.classList.remove('show');
document.getElementById('continue').onclick=()=>modal.classList.remove('show');

function showModal(c, finale=false){
  mTitle.textContent=c.name || "–°–æ–∑–≤–µ–∑–¥–∏–µ";
  mText.innerHTML=(c.text||[]).map(line=>`<p>${line}</p>`).join('');
  // –µ—Å–ª–∏ —Ñ–∏–Ω–∞–ª ‚Äî –¥–æ–±–∞–≤–∏–º –±–ª–æ–∫ —Å —Ç—Ä–µ–∫–∞–º–∏
  if(finale && FINAL_TRACKS.length){
    const wrap=document.createElement('div'); wrap.className='tracks';
    const h=document.createElement('p'); h.innerHTML='–ù–µ–π—Ä–æ—Ö–∏—Ç "–ö–æ—à–∫–æ—Å–µ–º—å—è" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:';
    wrap.appendChild(h);
    FINAL_TRACKS.forEach((t,i)=>{
      const d=document.createElement('div'); d.className='track';
      d.innerHTML=`<strong>${i+1}. ${escapeHtml(t.title)}</strong>`;
      const a=document.createElement('audio');
      a.controls=true; a.preload='none'; a.src=t.url; a.crossOrigin='anonymous';
      d.appendChild(a); wrap.appendChild(d);
    });
    mText.appendChild(wrap);
    // –∫–Ω–æ–ø–∫–∞ ¬´–î–∞–ª—å—à–µ¬ª –≤ —Ñ–∏–Ω–∞–ª–µ –Ω–µ –Ω—É–∂–Ω–∞
    document.getElementById('continue').style.display='none';
  }else{
    document.getElementById('continue').style.display='';
  }
  modal.classList.add('show');
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// –∫–æ—Ä–æ—Ç–∫–∞—è –≤—Å–ø—ã—à–∫–∞-—Ä–∏—Å—É–Ω–æ–∫
function flashShape(){
  const cx=W/2, cy=H/2, pts=[{x:cx-90,y:cy-30},{x:cx+40,y:cy-60},{x:cx+80,y:cy+20},{x:cx-20,y:cy+60}];
  let a=1; (function anim(){ ctx.save(); ctx.globalAlpha=a; ctx.lineWidth=1.6;
    ctx.strokeStyle='rgba(158,203,255,0.8)'; ctx.fillStyle='rgba(158,203,255,0.25)';
    for(const p of pts){ ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); }
    ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y);
    ctx.closePath(); ctx.stroke(); ctx.restore(); a-=0.02; if(a>0) requestAnimationFrame(anim); })();
}

function openConstellation(c, auto=false){
  if(!state.unlocked.includes(c.id)){ state.unlocked.push(c.id); save(); renderConstellations(); toast(`${c.name}: –æ—Ç–∫—Ä—ã—Ç–æ ‚ú®`); }
  flashShape(); if(!auto) ping(); showModal(c);
  if(CONSTS.every(x=>state.unlocked.includes(x.id))){
    setTimeout(()=> showModal({name:"–§–∏–Ω–∞–ª", text:[
      "–¢—ã —Å–æ–±—Ä–∞–ª–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ñ–∏–Ω–∞–ª!",
      "–Ø —Ç–∞–∫–æ–π —Å–µ–±–µ –º—É–∑—ã–∫–∞–Ω—Ç, –Ω–æ —Ö–æ—Ç–µ–ª —Ä–∞–∑–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –≤–µ—á–µ—Ä (–Ω–æ—á—å? –¥–µ–Ω—å?) —Å–º–µ—à–Ω–æ–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º—É–∑—ã–∫–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è, —Å–æ–ª–Ω—Ü–µ. –ù–∞–¥–µ—é—Å—å —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è!"
    ]}, true), 450);
  }
}

function tryOpenConstellation(c){
  if(state.unlocked.includes(c.id)){ showModal(c); return; }
  let spent=0; for(const x of CONSTS){ if(x.id===c.id) break; spent+=x.need; }
  const available=state.light-spent;
  if(available>=c.need) openConstellation(c); else toast("–°–æ–±–µ—Ä–∏ –µ—â—ë –Ω–µ–º–Ω–æ–≥–æ —Å–≤–µ—Ç–∞ ‚ú®");
}

function maybeUnlock(){
  let remaining=state.light;
  for(const c of CONSTS){
    if(state.unlocked.includes(c.id)) continue;
    if(remaining>=c.need){ openConstellation(c,true); remaining-=c.need; } else break;
  }
}

// –ó–≤—É–∫/—Å–±—Ä–æ—Å
const soundBtn=document.getElementById('soundBtn');
function updSound(){ soundBtn.textContent=state.sound?'üîî –ó–≤—É–∫: –≤–∫–ª':'üîï –ó–≤—É–∫: –≤—ã–∫–ª'; soundBtn.setAttribute('aria-pressed', String(state.sound)); }
soundBtn.onclick=()=>{ state.sound=!state.sound; updSound(); save(); ping(); }; updSound();

document.getElementById('resetBtn').onclick=()=>{
  if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')){
    state.light=0; state.unlocked=[]; save(); updateLightUI(); renderConstellations(); toast('–°–±—Ä–æ—à–µ–Ω–æ');
    const h=document.querySelector('.hint'); if(!h){ const el=document.createElement('div'); el.className='hint'; el.textContent='–ö–∞—Å–∞–π—Å—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –∑–≤—ë–∑–¥ ‚Äî —Å–æ–±–∏—Ä–∞–π —Å–≤–µ—Ç, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Å–æ–∑–≤–µ–∑–¥–∏—è.'; document.body.appendChild(el); }
  }
};

// –ø–æ–¥—Å–∫–∞–∑–∫–∞ ‚Üí —Å–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–≤–µ—Ç–∞
const hint=document.querySelector('.hint');
if(state.light>0 && hint) hint.remove();
new MutationObserver(()=>{ if(Number(lightCountEl.textContent)>0 && hint){ hint.remove(); } }).observe(lightCountEl, {childList:true});

// –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∑–≤—ë–∑–¥—ã –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ—Å–∞–π–∑–µ
let lastW=W,lastH=H;
addEventListener('resize', ()=>{ if(W!==lastW||H!==lastH){ lastW=W; lastH=H; initStars(); } }, {passive:true});
})();
</script>
</body>
</html>





