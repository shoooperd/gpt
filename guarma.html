<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ì—É–∞—Ä–º–∞ –∫–ª–∏–∫–µ—Ä ‚Äî v6 (—Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º)</title>
<style>
  :root{
    --bg:#0e1920; --panel:#12222b; --panel-2:#0f1c24; --border:#1a3340;
    --accent:#ffd44d; --accent-2:#ffe995; --focus:#79c6ff;
    --text:#e6f3f7; --muted:#a7c2cb; --good:#96f2a1; --bad:#ff9d9d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    background: radial-gradient(1200px 60% at 50% 100%, rgba(255,255,255,.05), transparent 60%), linear-gradient(180deg,#09131a, var(--bg));
  }

  .ui{display:grid; grid-template-columns: 320px 1fr 360px; gap:14px; min-height:100vh; padding:14px;}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.25);}
  header.card{grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; padding:10px 14px;}
  .brand{display:flex; gap:10px; align-items:center}
  .brand .seal{font-size:26px}
  .brand h1{margin:0; font-size:20px; letter-spacing:.2px}
  .subtitle{font-size:12px; color:var(--muted)}
  .counter{display:flex; gap:14px; align-items:baseline; flex-wrap:wrap}
  .counter .label{opacity:.9}
  .counter .value{font-variant-numeric:tabular-nums; font-size:28px; color:var(--accent)}
  .counter small{color:var(--muted)}
  .rightbar{display:flex; align-items:center; gap:10px}

  .btn{background:#163240; border:1px solid var(--border); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .btn:focus-visible{outline:2px solid var(--focus); outline-offset:2px}
  .toggle{min-width:86px; text-align:center}
  .pill{padding:4px 8px; border-radius:999px; font-size:12px; background:#12303b; border:1px solid var(--border); color:var(--muted)}
  .pill.good{color:#bdf6c5} .pill.bad{color:#ffd2d2}

  .panel{padding:10px}
  .section-title{margin:0 0 8px 0; font-size:14px; color:var(--accent-2); letter-spacing:.3px}
  .shop-list{display:grid; gap:8px}
  .item{background:var(--panel-2); border:1px solid var(--border); border-radius:10px; padding:8px; display:grid;
    grid-template-columns:auto 1fr auto; gap:10px; align-items:center}
  .item .emoji{font-size:22px}
  .item .name{font-weight:700}
  .item .desc{font-size:12px; color:var(--muted)}
  .item .price{font-variant-numeric:tabular-nums; color:var(--accent)}
  .stats{display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px; color:var(--muted)}
  .stats div{background:var(--panel-2); border:1px solid var(--border); border-radius:8px; padding:8px}
  .help{font-size:12px; color:var(--muted); padding-top:2px}

  .center.card{
    display:flex; justify-content:center; align-items:flex-start;
    padding: clamp(12px, 6vh, 48px) 12px 12px; position:relative; overflow:hidden;
  }
  .scene{position:absolute; inset:0; pointer-events:none; opacity:.18; background:
    radial-gradient(1000px 60% at 50% 110%, rgba(255,255,255,.06), transparent 70%),
    url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox=\"0 0 800 400\" preserveAspectRatio=\"none\">\
        <rect width=\"800\" height=\"400\" fill=\"#0e1f26\"/>\
        <g fill=\"#0f3d3a\" opacity=\"0.65\">\
          <ellipse cx=\"\" cy=\"330\" rx=\"220\" ry=\"60\"/>\
          <ellipse cx=\"650\" cy=\"350\" rx=\"260\" ry=\"60\"/>\
        </g>\
      </svg>') center/cover no-repeat;}
  .click-wrap{position:relative; display:grid; place-items:center; gap:8px; z-index:1}
  .click-target{
    width:min(40vh, 300px); aspect-ratio:1; border-radius:16px;
    background:#18323b; border:1px solid var(--border);
    display:grid; place-items:center; cursor:pointer; user-select:none;
    box-shadow: 0 10px 22px rgba(0,0,0,.28), inset 0 0 0 9999px rgba(255,255,255,.02);
    transition: transform .06s ease, box-shadow .12s ease, background .2s ease, outline-color .2s ease;
    outline:2px solid transparent;
  }
  .click-target:hover{box-shadow: 0 12px 28px rgba(0,0,0,.32)}
  .click-target:active{transform:translateY(1px) scale(.995)}
  .click-target.golden{outline-color:#ffdf6a; box-shadow:0 0 0 2px rgba(255,223,106,.35), 0 18px 44px rgba(255,223,106,.18)}
  .click-emoji{font-size:min(18vh, 120px)}
  .click-caption{font-size:13px; color:var(--muted)}

  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#0f2f38; border:1px solid var(--border);
    padding:10px 14px; border-radius:10px; box-shadow:0 8px 22px rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:.25s}
  .toast.show{opacity:1}
  .floating{position:absolute; pointer-events:none; font-weight:700; text-shadow:0 1px 0 #0008; animation:floatUp 900ms ease-out forwards}
  @keyframes floatUp{from{transform:translateY(0); opacity:1} to{transform:translateY(-60px); opacity:0}}

  .tree{display:grid; gap:10px}
  .branch{background:var(--panel-2); border:1px solid var(--border); border-radius:10px; padding:10px}
  .branch h4{margin:0 0 8px 0; font-size:13px; color:var(--accent-2); letter-spacing:.2px}
  .ach{display:grid; gap:6px; margin:6px 0; padding:6px; border-radius:8px; border:1px dashed #214050}
  .ach-head{display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center}
  .ach-icon{font-size:18px}
  .ach-name{font-weight:700}
  .ach-req{font-size:12px; color:var(--muted)}
  .bar{height:8px; background:#0d2832; border-radius:6px; overflow:hidden; border:1px solid #153340}
  .bar>span{display:block; height:100%; background:linear-gradient(90deg, #ffde7a, #ffd44d); width:0%}
  .ach.done{border-style:solid}
  .ach.done .bar>span{background:linear-gradient(90deg,#8cff9a,#48d46b)}
  .ach-note{font-size:11px; color:var(--muted)}

  .buffs{display:flex; gap:6px; flex-wrap:wrap}
  .buff{font-size:11px; padding:4px 6px; border-radius:8px; border:1px solid var(--border); background:#0e3541}
  .buff.good{outline:1px solid #1d6f42}
  .buff.bad{outline:1px solid #7a2c2c}
</style>
</head>
<body>
<header class="card">
  <div class="brand">
    <div class="seal">ü¶ú</div>
    <div>
      <h1>–ì—É–∞—Ä–º–∞ –∫–ª–∏–∫–µ—Ä</h1>
      <div class="subtitle">–¥–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–π –ì—É–∞—Ä–º—ã</div>
    </div>
  </div>
  <div class="counter">
    <div class="label">–†–∞—Å—Ç—Ä–µ–ª–µ–Ω–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–∏–∫–æ–≤:</div>
    <div class="value" id="score">0</div>
    <small>(–∫–ª–∏–∫ ‚Äî <span id="cpc">1</span>, —Å–µ–∫ ‚Äî <span id="cps">0</span>)</small>
  </div>
  <div class="rightbar">
    <div id="seasonTag" class="pill">–°–µ–∑–æ–Ω: ‚Äî</div>
    <button class="btn toggle" id="muteBtn">üîä –ó–≤—É–∫</button>
    <button class="btn" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn" id="wipeBtn">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
  </div>
</header>

<div class="ui">
  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∞–ø–≥—Ä–µ–π–¥—ã –∫–ª–∏–∫–∞ -->
  <aside class="card">
    <div class="panel">
      <h3 class="section-title">–£–ª—É—á—à–µ–Ω–∏—è –∫–ª–∏–∫–∞</h3>
      <div id="clickups" class="shop-list"></div>
      <div class="help">–°–æ–≤–µ—Ç: —Å–ø–µ—Ä–≤–∞ —Ä–∞–∑–≥–æ–Ω—è–π –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥, –ø–æ—Ç–æ–º —É—Å–∏–ª–∏–≤–∞–π –∫–ª–∏–∫ –¥–ª—è —Ä–∞—Å—Å—Ç—Ä–µ–ª–æ–≤</div>
    </div>
  </aside>

  <!-- –¶–µ–Ω—Ç—Ä -->
  <main class="center card" aria-label="–ò–≥—Ä–æ–≤–∞—è —Å—Ü–µ–Ω–∞">
    <div class="scene" aria-hidden="true"></div>
    <div class="click-wrap">
      <div id="clickTarget" class="click-target" role="button" aria-label="–†–∞—Å—Å—Ç—Ä–µ–ª—è—Ç—å">
        <div class="click-emoji" id="clickEmoji" aria-hidden="true">üë®üèø</div>
      </div>
      <div class="click-caption">–î–µ–π—Å—Ç–≤–∏–µ –∫–ª–∏–∫–∞: <b>–†–∞—Å—Å—Ç—Ä–µ–ª—è—Ç—å</b></div>
      <div class="buffs" id="buffsCenter"></div>
    </div>
  </main>

  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
  <aside class="card">
    <div class="panel">
      <h3 class="section-title">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–¥–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É)</h3>
      <div id="mods" class="shop-list"></div>
    </div>

    <div class="panel">
      <h3 class="section-title">–°–µ–∑–æ–Ω–Ω—ã–µ –∏–≤–µ–Ω—Ç—ã</h3>
      <div class="buffs" id="buffs"></div>
      <div class="subtitle" id="seasonTimer">–°–ª–µ–¥. –∏–≤–µ–Ω—Ç —á–µ—Ä–µ–∑ ‚Äî</div>
    </div>

    <div class="panel">
      <h3 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      <div class="stats" style="margin-bottom:8px">
        <div>–í—Å–µ–≥–æ —Ä–∞—Å—Å—Ç—Ä–µ–ª–æ–≤: <b id="totalClicks">0</b></div>
        <div>–ö—É–ø–ª–µ–Ω–æ —É–ª—É—á—à–µ–Ω–∏–π: <b id="bought">0</b></div>
        <div>–ë–æ–Ω—É—Å –∫–ª–∏–∫–∞: <b id="cpcStat">+0</b></div>
        <div>–ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø–æ—Ä—è–¥–∫–∞: <b id="satireMult">x1.00</b></div>
      </div>
      <h3 class="section-title" style="margin-top:10px">–î—Ä–µ–≤–æ –∞—á–∏–≤–æ–∫</h3>
      <div id="achTree" class="tree"></div>
    </div>

    <div class="panel">
      <h3 class="section-title">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —É–∫–∞–∑—ã –∏ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è</h3>
      <div id="log" class="subtitle" style="line-height:1.35"></div>
    </div>
  </aside>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  // ====== –°–û–°–¢–û–Ø–ù–ò–ï v6 ======
  const state = {
    version: 6,
    score: 0,
    baseCPC: 1,
    bonusCPC: 0,
    cpcMult: 1,
    cps: 0,
    totalClicks: 0,
    satireStacks: 0,
    audioOn: true,
    activeBuffs: [], // {id,name,multCPS,multCPC,until,bad,onExpire}
    achievements: {}, // id: {progress, done}
    season: null, // {name, tag, goodBias}
    nextSeasonEventAt: 0,
    stats: { eventGood:0, eventBad:0, baldozh:0, maxBurst3s:0 },
    recentClicks: [], // timestamps (ms) for burst tracking
    items:{
      // –ë–´–í–®–ò–ï ¬´–º–æ–¥—ã/—Å–µ–∫¬ª -> —Ç–µ–ø–µ—Ä—å —É—Å–∏–ª–∏–≤–∞—é—Ç –ö–õ–ò–ö (CPC)
      mods:[
        { id:'whip',   name:'–ü–ª–µ—Ç—å –ì–µ–Ω–µ—Ä–∞–ª-—Å–µ—Ä–∂–∞–Ω—Ç–∞ –£–æ–∫–µ—Ä–∞', emoji:'üèµÔ∏è', desc:'–†–∏—Ç–º –ø–ª–µ—Ç–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–∏–ª—É –∫–ª–∏–∫–∞.', base:50,    add:2,    owned:0, scale:1.15 },
        { id:'goats',  name:'–†—É—á–Ω—ã–µ –∫–æ–∑–ª–æ–ø–∞—Å—ã –∏–∑ –í–∞–ª–µ–Ω—Ç–∞–π–Ω–∞', emoji:'üêê', desc:'–ü–æ–¥–ø–∏–Ω—ã–≤–∞—é—Ç –≤—É—Ä–¥–∞–ª–∞–∫–æ–≤ –∏ –Ω–æ—Å—è—Ç –ø–∞—Ç—Ä–æ–Ω—ã.', base:,   add:6,    owned:0, scale:1.15 },
        { id:'sheriff',name:'–®–µ—Ä–∏—Ñ-–≤—É—Ä–¥–∞–ª–∞–∫ —Å –±–æ–ª—å—à–æ–π –∑–µ–º–ª–∏', emoji:'üßü‚Äç‚ôÇÔ∏è', desc:'–°—Ç—Ä–µ–ª—è–µ—Ç –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—Ç–±–æ—è.',   base:900,   add:30,   owned:0, scale:1.16 },
        { id:'medal',  name:'–ù–∞–≥—Ä–∞–¥–Ω–∞—è –º–µ–¥–∞–ª—å –õ–µ—Ä—É–∞ –ú–µ—Ä–ª–µ–Ω',  emoji:'üéñÔ∏è', desc:'–ë–ª–µ—Å–∫ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä—É–µ—Ç –≤—Å–µ—Ö.',      base:3500,  add:120,  owned:0, scale:1.17 },
        { id:'beer',   name:'–Ø—â–∏–∫ –ø–∏–≤–∞ ¬´–ü–∏–∫–ª–∑¬ª',              emoji:'üç∫', desc:'–ú–æ—Ä–∞–ª—å ‚Üë, –∫–ª–∏–∫ –±–æ–¥—Ä–µ–µ.',           base:00, add:600,  owned:0, scale:1.18 },
        { id:'donkeys',name:'–û—Å–ª–∏–Ω–∞—è –∫–∞–≤–∞–ª–µ—Ä–∏—è –ì—É–∞—Ä–º—ã',       emoji:'üê¥', desc:'–í–µ–ª–∏–∫–∞—è –º–æ—â—å –∑–∞ 2000$.', base:80000, add:3000, owned:0, scale:1.19 },
      ],
      // –ë–´–í–®–ò–ï ¬´—É–ª—É—á—à–µ–Ω–∏—è –∫–ª–∏–∫–∞¬ª -> —Ç–µ–ø–µ—Ä—å –ø–∞—Å—Å–∏–≤–Ω—ã–π –î–û–•–û–î (CPS) –∏ –∑–∞–º–µ—Ç–Ω–æ –±–æ–ª—å—à–µ
      clickups:[
        { id:'tumble', name:'–ü—É—Ç—ë–≤–∫–∏ –∏–∑ –¢–∞–º–±–ª–≤–∏–¥–∞', emoji:'üé´', desc:'–ú–∏–≥—Ä–∞—Ü–∏—è –≤—É—Ä–¥–∞–ª–∞–∫–æ–≤.', cps:5,    base:800,   owned:0, scale:1.40 },
        { id:'cells',  name:'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª–µ—Ç–∫–∏', emoji:'üóÇÔ∏è', desc:'–ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ - –±–æ–ª—å—à–µ –º–∏—à–µ–Ω–µ–π.',    cps:30,   base:4800,  owned:0, scale:1.45 },
        { id:'ark',    name:'–ö–æ–≤—á–µ–≥ –ø—Ä–∞–≤–æ—Å—É–¥–∏—è',     emoji:'üõ≥Ô∏è', desc:'–ö–∞–∂–¥–æ–π —Ç–≤–∞—Ä–∏ –ø–æ –∞–≤–∞—Ç–∞—Ä–∏–∏.',            cps:180,  base:32000, owned:0, scale:1.50 },
      ]
    }
  };

  // ====== –ê–£–î–ò–û ======
  let AC;
  function ensureAC(){ if(!state.audioOn) return null; if(!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); return AC; }
  function clickSound(){
    if(!ensureAC()) return;
    const ctx=AC,o=ctx.createOscillator(),g=ctx.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(520,ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(240, ctx.currentTime+.06);
    g.gain.setValueAtTime(.14,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+.08);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.09);
  }
  function rewardSound(){
    if(!ensureAC()) return;
    const ctx=AC,o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain();
    o1.type='sine';o2.type='sine';g.gain.value=.12;o1.connect(g);o2.connect(g);g.connect(ctx.destination);
    o1.frequency.value=660;o2.frequency.value=880;o1.start();o2.start();
    o1.frequency.exponentialRampToValueAtTime(990, ctx.currentTime+.2);
    o2.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime+.2);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+.25);
    o1.stop(ctx.currentTime+.26); o2.stop(ctx.currentTime+.26);
  }

  // ====== UI ======
  const els = {
    score: q('#score'), cpc: q('#cpc'), cps: q('#cps'),
    target: q('#clickTarget'), buffs: q('#buffs'), buffsCenter: q('#buffsCenter'),
    mods: q('#mods'), clickups: q('#clickups'),
    log: q('#log'), toast: q('#toast'),
    totalClicks: q('#totalClicks'), bought: q('#bought'),
    cpcStat: q('#cpcStat'), satireMult: q('#satireMult'),
    saveBtn: q('#saveBtn'), wipeBtn: q('#wipeBtn'),
    muteBtn: q('#muteBtn'), seasonTag: q('#seasonTag'), seasonTimer: q('#seasonTimer'),
    achTree: q('#achTree')
  };
  function q(s){return document.querySelector(s)}
  const fmt = n => Math.floor(Math.max(0,n)).toLocaleString('ru-RU');
  const softFmt = n => n >= 1000 ? Intl.NumberFormat('ru-RU',{notation:'compact',maximumFractionDigits:2}).format(n) : Math.round(n*100)/100;

  // ====== –≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä—ã ======
  function satireMultiplier(){ return 1 + (Math.floor(state.satireStacks/20))*0.05; }
  function price(base, scale, owned){ return Math.ceil(base * Math.pow(scale, owned)); }
  function buffsMult(kind){
    const now=performance.now();
    return state.activeBuffs.filter(b=>b.until>now).reduce((m,b)=> m * (kind==='cps'?(b.multCPS??1):(b.multCPC??1)), 1);
  }
  function currentCPC(){ return (state.baseCPC + state.bonusCPC) * state.cpcMult * buffsMult('cpc'); }
  function currentCPS(){ return state.cps * satireMultiplier() * buffsMult('cps'); }

  // ====== –ú–∞–≥–∞–∑–∏–Ω ======
  function renderShops(){
    els.clickups.innerHTML='';
    state.items.clickups.forEach(it=>{
      const cost=price(it.base,it.scale,it.owned);
      const row=document.createElement('div'); row.className='item';
      row.innerHTML=`
        <div class="emoji">${it.emoji}</div>
        <div><div class="name">${it.name}</div>
          <div class="desc">${it.desc}<br><span class="subtitle">+${it.cps}/—Å–µ–∫ ‚Ä¢ –í–ª–∞–¥–µ–Ω–∏–µ: ${it.owned}</span></div></div>
        <div><div class="price">${fmt(cost)}</div>
          <button class="btn" ${state.score<cost?'disabled':''}>–ö—É–ø–∏—Ç—å</button></div>`;
      row.querySelector('button').onclick=()=>buyClickup(it.id);
      els.clickups.appendChild(row);
    });

    els.mods.innerHTML='';
    state.items.mods.forEach(it=>{
      const cost=price(it.base,it.scale,it.owned);
      const row=document.createElement('div'); row.className='item';
      row.innerHTML=`
        <div class="emoji">${it.emoji}</div>
        <div><div class="name">${it.name}</div>
          <div class="desc">${it.desc}<br><span class="subtitle">+${it.add} –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞ ‚Ä¢ –í–ª–∞–¥–µ–Ω–∏–µ: ${it.owned}</span></div></div>
        <div><div class="price">${fmt(cost)}</div>
          <button class="btn" ${state.score<cost?'disabled':''}>–ö—É–ø–∏—Ç—å</button></div>`;
      row.querySelector('button').onclick=()=>buyMod(it.id);
      els.mods.appendChild(row);
    });
  }
  function buyMod(id){
    const it=state.items.mods.find(x=>x.id===id);
    const cost=price(it.base,it.scale,it.owned); if(state.score<cost) return;
    state.score-=cost; it.owned++; state.bonusCPC+=it.add; state.satireStacks++;
    addLog(`–£—Å–∏–ª–µ–Ω –∫–ª–∏–∫: <b>${it.name}</b> (+${it.add}).`);
    updateUI(); save();
  }
  function buyClickup(id){
    const it=state.items.clickups.find(x=>x.id===id);
    const cost=price(it.base,it.scale,it.owned); if(state.score<cost) return;
    state.score-=cost; it.owned++; state.cps+=it.cps; state.satireStacks++;
    addLog(`–ó–∞–∫—É–ø–ª–µ–Ω–æ: <b>${it.name}</b>. –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ +${it.cps}/—Å–µ–∫.`);
    updateUI(); save();
  }

  // ====== –ö–ª–∏–∫ ======
  const GOLD_CHANCE = 0.0015; // ~0.15% –Ω–∞ –∫–ª–∏–∫ ‚Äî –∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ
  function registerClickBurst(){
    const now=performance.now();
    state.recentClicks.push(now);
    // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—à–µ 3—Å
    const cutoff=now-3000;
    while(state.recentClicks.length && state.recentClicks[0]<cutoff) state.recentClicks.shift();
    if(state.recentClicks.length > state.stats.maxBurst3s) state.stats.maxBurst3s = state.recentClicks.length;
  }
  function clickGain(e){
    if(Math.random() < GOLD_CHANCE){
      triggerDedBaldyozh();
    }
    const gain=currentCPC();
    state.score+=gain; state.totalClicks++; clickSound(); registerClickBurst();
    spawnFloat(e.clientX,e.clientY,'+'+softFmt(gain));
    updateUI();
  }
  function spawnFloat(x,y,text){
    const f=document.createElement('div'); f.className='floating';
    f.style.left=(x-10)+'px'; f.style.top=(y-18)+'px'; f.textContent=text;
    document.body.appendChild(f); setTimeout(()=>f.remove(),900);
  }

 // ====== ¬´–ó–û–õ–û–¢–û–ô –ö–õ–ò–ö¬ª: –ë–∞–ª–¥—ë–∂ (—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø—É—Ä—Ç) ======
function triggerDedBaldyozh(){
  // –∫–æ—Ä–æ—Ç–∫–∏–π –±—É—Å—Ç 5—Å, –∑–∞—Ç–µ–º –∂—ë—Å—Ç–∫–∏–π –æ—Ç–∫–∞—Ç 12—Å
  const ms = 5000;       // 5 —Å–µ–∫—É–Ω–¥ –±—É—Å—Ç–∞
  const debuffMs = 12000;
  const startMsg = 'üí• –ë–∞–ª–¥—ë–∂! CPC √ó10 –∏ CPS √ó5 –Ω–∞ 5 —Å–µ–∫';
  const endMsg   = 'üö´ –ë–∞–ª–¥—ë–∂ –ø—Ä–æ—à—ë–ª (CPS ‚àí85% –Ω–∞ 12 —Å–µ–∫)';

  els.target.classList.add('golden');

  // –æ—Å–Ω–æ–≤–Ω–æ–π –±—É—Å—Ç: CPS √ó5, CPC √ó10
  temporaryBoost(
    5,          // multCPS
    ms,
    startMsg,
    false,
    'cps',
    () => {     // onExpire
      els.target.classList.remove('golden');
      addLog('üïØÔ∏è ' + endMsg);
      toast(endMsg);
      // –æ—Ç–∫–∞—Ç –ø–æ—Å–ª–µ —Å–ø—É—Ä—Ç–∞
      temporaryBoost(0.15, debuffMs, '‚ö†Ô∏è –ü–æ—Å–ª–µ –ë–∞–ª–¥—ë–∂–∞', true, 'cps');
    },
    10          // multCPC
  );

  state.stats.baldozh++;
  rewardSound();
}

  // ====== –°–µ–∑–æ–Ω—ã –ì—É–∞—Ä–º—ã ======
  const SEASONS = [
    { id:'dry',  months:[12,1,2,3,4,5], name:'–°—É—Ö–æ–π —Å–µ–∑–æ–Ω', tag:'‚òÄÔ∏è –°—É—Ö–æ', goodBias:0.65,
      events:[
        {name:'–ö–∞—Ä–Ω–∞–≤–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è', mult:1.18, ms:16000, affect:'cps', good:true, text:'–ü—Ä–∞–∑–¥–Ω–∏–∫, –Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–µ—Å–µ–ª–µ–µ.'},
        {name:'–ü–∞—Ä–∞–¥ –ì–µ–Ω–µ—Ä–∞–ª-—Å–µ—Ä–∂–∞–Ω—Ç–∞', mult:1.15, ms:12000, affect:'cpc', good:true, text:'–ü–µ—á–∞—Ç–∏ –ø–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∏ –ª–æ–∂–∞—Ç—Å—è –ª–µ–≥—á–µ.'},
        {name:'–ü—ã–ª—å–Ω—ã–µ —Ç—Ä–æ–ø—ã', mult:0.93, ms:14000, affect:'cps', good:false, text:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∑–∞–º–µ–¥–ª–µ–Ω.'}
      ]},
    { id:'wet',  months:[6,7,8,9,10,11], name:'–î–æ–∂–¥–µ–≤–æ–π —Å–µ–∑–æ–Ω', tag:'üåßÔ∏è –î–æ–∂–¥–∏', goodBias:0.45,
      events:[
        {name:'–¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π –ª–∏–≤–µ–Ω—å', mult:0.9,  ms:16000, affect:'cps', good:false, text:'–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –±—É–∫—Å—É–µ—Ç –≤ –≥—Ä—è–∑–∏.'},
        {name:'–ì—Ä–æ–∑–∞ ¬´–°–∞–Ω—Ç–æ-–î–æ–º–∏–Ω–≥–æ¬ª', mult:1.12, ms:12000, affect:'cpc', good:true, text:'–ö–ª–∏–∫–∏ –∏—Å–∫—Ä—è—Ç –±–æ–¥—Ä–µ–µ.'},
        {name:'–®—Ç–æ—Ä–º ¬´–ö–ª–∞—Ä–∞¬ª', mult:0.88, ms:18000, affect:'cps', good:false, text:'–õ–æ–¥–∫–∏ —à–≤–∞—Ä—Ç—É—é—Ç—Å—è. –í—Å—ë –º–µ–¥–ª–µ–Ω–Ω–µ–µ.'},
        {name:'–ö–æ–∫–æ—Å–æ–≤—ã–π —É—Ä–æ–∂–∞–π', mult:1.2,  ms:15000, affect:'cps', good:true, text:'–°–∫–ª–∞–¥ –ø–æ–ø–æ–ª–Ω–∏–ª—Å—è –∫–æ–∫–æ—Å–∞–º–∏.'}
      ]}
  ];
  function detectSeason(){
    const m=(new Date()).getMonth()+1;
    const s=SEASONS.find(s=>s.months.includes(m)) || SEASONS[0];
    state.season=s; els.seasonTag.textContent='–°–µ–∑–æ–Ω: '+s.name; els.seasonTag.className='pill';
  }
  function scheduleNextSeasonEvent(now){ state.nextSeasonEventAt = now + (12000 + Math.random()*15000); }
  function rollSeasonEvent(now){
    if(now < state.nextSeasonEventAt) return;
    scheduleNextSeasonEvent(now);
    const pool=state.season.events;
    const goodPool=pool.filter(e=>e.good), badPool=pool.filter(e=>!e.good);
    const pickGood=Math.random() < state.season.goodBias;
    const list = pickGood ? goodPool : badPool;
    const e=list[Math.floor(Math.random()*list.length)];
    const sign=e.mult>1?'+':'';
    temporaryBoost(e.mult,e.ms,`${pickGood?'‚úÖ':'‚ö†Ô∏è'} ${e.name}: ${e.text} (${sign}${Math.round((e.mult-1)*100)}% –Ω–∞ ${Math.round(e.ms/1000)}—Å)`, !e.good, e.affect);
    // —É—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if(pickGood) state.stats.eventGood++; else state.stats.eventBad++;
  }

  // ====== –ë–∞—Ñ—Ñ—ã ======
  function temporaryBoost(mult, ms, message, bad=false, affect='cps', onExpire=null, multCPC_opt=null){
    const id='buff_'+Math.random().toString(36).slice(2), until=performance.now()+ms;
    const b={id,name:message,multCPS:affect==='cps'?mult:1,multCPC:affect==='cpc'?(multCPC_opt||mult): (multCPC_opt||1),until,bad,onExpire};
    state.activeBuffs.push(b); addLog((bad?'‚ö†Ô∏è ':'‚úÖ ')+message); updateBuffsUI();
    setTimeout(()=>{ 
      state.activeBuffs=state.activeBuffs.filter(x=>x.id!==id); 
      updateBuffsUI(); 
      if(typeof b.onExpire==='function') b.onExpire();
    }, ms+80);
  }
  function updateBuffsUI(){
    const now=performance.now(); els.buffs.innerHTML=''; els.buffsCenter.innerHTML='';
    state.activeBuffs.filter(b=>b.until>now).forEach(b=>{
      const left=Math.max(0,Math.round((b.until-now)/1000));
      const el=document.createElement('div'); el.className='buff '+(b.bad?'bad':'good');
      el.textContent=b.name.replace(/^‚úÖ |^‚ö†Ô∏è /,'')+' ¬∑ '+left+'—Å';
      els.buffs.appendChild(el.cloneNode(true));
      els.buffsCenter.appendChild(el);
    });
  }

  // ====== –õ–æ–≥/—Ç–æ—Å—Ç ======
  function addLog(text){
    const stamps=['¬´–£–∫–∞–∑ ‚Ññ'+(100+Math.floor(Math.random()*900))+' –ø–æ–¥–ø–∏—Å–∞–Ω¬ª','¬´–°–∏—Ç—É–∞—Ü–∏—è –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º¬ª','¬´–ü–ª–∞–Ω –ë? –°–∫–æ—Ä–µ–µ –í¬ª','¬´–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ —é–º–æ—Ä–∞ —Å–æ–≥–ª–∞—Å–Ω–æ¬ª','¬´–ì—É–∞—Ä–º–∏—è –≥–æ—Ä–¥–∏—Ç—Å—è –≤–∞–º–∏!¬ª'];
    const line=`<div>üóûÔ∏è ${text} <span class="subtitle">‚Äî ${stamps[Math.floor(Math.random()*stamps.length)]}</span></div>`;
    els.log.insertAdjacentHTML('afterbegin', line);
  }
  function toast(msg){ els.toast.textContent=msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),1600); }

  // ====== –î—Ä–µ–≤–æ –∞—á–∏–≤–æ–∫ (v6 —Ä–∞—Å—à–∏—Ä–µ–Ω–æ) ======
  const achTreeSpec = [
    { id:'branch_clicks', name:'–ö–∞–Ω—Ü–µ–ª—è—Ä–∏—è —Ä–∞—Å—Å—Ç—Ä–µ–ª–æ–≤', icon:'üñ±Ô∏è', nodes:[
      { id:'clicks_50',  name:'–ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Ä–µ–≤–æ–ª—å–≤–µ—Ä', icon:'‚òùÔ∏è', goal:50,   get: s=>s.totalClicks },
      { id:'clicks_500', name:'–°—Ç–≤–æ–ª –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏',  icon:'‚úåÔ∏è', goal:500,  get: s=>s.totalClicks },
      { id:'clicks_5k',  name:'–°—Ç–≤–æ–ª –ì–µ–Ω–µ—Ä–∞–ª-—Å–µ—Ä–∂–∞–Ω—Ç–∞', icon:'üññ', goal:5000, get: s=>s.totalClicks },
    ]},
    { id:'branch_econ', name:'–≠–∫–æ–Ω–æ–º–∏–∫–∞', icon:'üí∞', nodes:[
      { id:'score_10k', name:'–ö–∞–∑–Ω–∞ –ì—É–∞—Ä–º—ã', icon:'üè¶', goal:1e4,  get: s=>s.score },
      { id:'score_1m',  name:'–ó–æ–ª–æ—Ç–æ–π –∫–æ–∫–æ—Å', icon:'ü••', goal:1e6, get: s=>s.score },
    ]},
    { id:'branch_shop', name:'–°–Ω–∞–±–∂–µ–Ω–∏–µ', icon:'üßæ', nodes:[
      { id:'buy_total_10', name:'–†–∞—Å—Å—Ç—Ä–µ–ª—å–Ω—ã–π —É–∫–∞–∑', icon:'üìù', goal:10, get: s=> totalOwned() },
      { id:'donkeys_5',    name:'–®—Ç–∞–±-–æ—Å–ª—è—Ç–Ω–∏–∫',   icon:'üê¥', goal:5,  get: s=> getOwned('donkeys') },
      { id:'mods_fullset', name:'–ö–æ–º–ø–ª–µ–∫—Ç —Å–Ω–∞–±–∂–µ–Ω–∏—è', icon:'üéñÔ∏è', goal:1, get: s=> allBoughtOnce()?1:0 },
    ]},
    { id:'branch_events', name:'–°–µ–∑–æ–Ω—ã', icon:'üå¥', nodes:[
      { id:'ev_good3', name:'–ü—Ä–∞–∑–¥–Ω–∏–∫ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã', icon:'üé∫', goal:3, get: s=>s.stats.eventGood },
      { id:'ev_bad3',  name:'–ì—É–∞—Ä–º—Å–∫–∞—è —Å—Ç–æ–π–∫–æ—Å—Ç—å', icon:'üõ°Ô∏è', goal:3, get: s=>s.stats.eventBad },
    ]},
    // –ù–æ–≤—ã–µ –ª–æ—Ä–Ω—ã–µ –≤–µ—Ç–∫–∏
    { id:'branch_lore', name:'–°–ª–∞–≤–∞ –ì–µ–Ω–µ—Ä–∞–ª-—Å–µ—Ä–∂–∞–Ω—Ç—É', icon:'ü¶ú', nodes:[
      { id:'baldozh_1',  name:'–ü–µ—Ä–≤—ã–π –ë–∞–ª–¥—ë–∂', icon:'ü•á', goal:1, get: s=> s.stats.baldozh },
      { id:'baldozh_5',  name:'–î–µ–¥ –ë–æ–º–±—ë–∂',     icon:'üéâ', goal:5, get: s=> s.stats.baldozh },
      { id:'walker_100k',name:'–ö–∞–∑–Ω–∞ –ò—Ç–∞–Ω–∞',   icon:'üíÇ‚Äç‚ôÇÔ∏è', goal:100000, get: s=> s.score },
      { id:'tropic_king',name:'–ö–æ—Ä–æ–ª—å —Ç—Ä–æ–ø–∏–∫–æ–≤', icon:'üëë', goal:1, get: s=> allBoughtOnce()?1:0 },
    ]},
    { id:'branch_misc', name:'–û—Å–æ–±—ã–µ —Ä–∞—Å—Å—Ç—Ä–µ–ª—ã', icon:'üìú', nodes:[
      { id:'burst_25in3s', name:'–ü—Ä–æ—Ç–æ–∫–æ–ª –ê–≤–∞—Ç–∞—Ä–∏—è', icon:'‚ö°', goal:25, get: s=> s.stats.maxBurst3s },
      { id:'prestige_1',   name:'–†–µ—Ñ–æ—Ä–º–∞ ‚Ññ1',       icon:'üîÑ', goal:100, get: s=> s.satireStacks },
    ]},
  ];
  function totalOwned(){return state.items.mods.reduce((a,b)=>a+b.owned,0)+state.items.clickups.reduce((a,b)=>a+b.owned,0)}
  function getOwned(id){const m=state.items.mods.concat(state.items.clickups).find(x=>x.id===id); return m?m.owned:0}
  function allBoughtOnce(){return state.items.mods.every(x=>x.owned>=1)}

  function buildAchTree(){
    els.achTree.innerHTML='';
    achTreeSpec.forEach(branch=>{
      const box=document.createElement('div'); box.className='branch';
      box.innerHTML=`<h4>${branch.icon} ${branch.name}</h4>`;
      branch.nodes.forEach(n=>{
        const cur=n.get(state); const pct=Math.max(0,Math.min(100, Math.floor((cur/n.goal)*100)));
        const done=pct>=100;
        state.achievements[n.id] = {progress: cur, done: done || (state.achievements[n.id]?.done||false)};
        const ach=document.createElement('div'); ach.className='ach'+(state.achievements[n.id].done?' done':'');
        ach.innerHTML = `
          <div class="ach-head">
            <div class="ach-icon">${n.icon}</div>
            <div class="ach-name">${n.name}</div>
            <div class="ach-req">${fmt(Math.min(cur,n.goal))} / ${fmt(n.goal)}</div>
          </div>
          <div class="bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å"><span style="width:${pct}%"></span></div>
          <div class="ach-note">${state.achievements[n.id].done?'–ó–∞–≤–µ—Ä—à–µ–Ω–æ':'–í –ø—Ä–æ—Ü–µ—Å—Å–µ'}</div>`;
        box.appendChild(ach);
      });
      els.achTree.appendChild(box);
    });
  }

  // ====== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ======
  function save(){ localStorage.setItem('guarma_save_v6', JSON.stringify(state)); }
  function load(){
    const raw=localStorage.getItem('guarma_save_v6');
    if(!raw) return;
    try{
      const s=JSON.parse(raw);
      if(s.version!==6) return;
      Object.assign(state,s);
      // –ø–µ—Ä–µ—Å—á—ë—Ç cps –ø–æ –ø–∞—Å—Å–∏–≤–∫–∞–º (–Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π)
      state.cps=0; state.items.clickups.forEach(it=> state.cps += (it.cps||0) * it.owned);
      if(!(state.score>=0)) state.score=0;
    }catch(e){ console.warn('save load fail', e) }
  }

  // ====== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI ======
  function updateUI(){
    els.score.textContent=fmt(state.score);
    els.cpc.textContent=softFmt(currentCPC());
    els.cps.textContent=softFmt(currentCPS());
    els.totalClicks.textContent=fmt(state.totalClicks);
    els.bought.textContent=fmt(totalOwned());
    els.cpcStat.textContent='+'+softFmt(state.bonusCPC);
    els.satireMult.textContent='x'+satireMultiplier().toFixed(2);
    renderShops(); updateBuffsUI(); buildAchTree();
  }
  function updateUIShallow(){
    els.score.textContent=fmt(state.score);
    els.cps.textContent=softFmt(currentCPS());
    updateBuffsUI();
    const left=Math.max(0, Math.round((state.nextSeasonEventAt - performance.now())/1000));
    els.seasonTimer.textContent = left>0 ? ('–°–ª–µ–¥. –∏–≤–µ–Ω—Ç —á–µ—Ä–µ–∑ ' + left + '—Å') : '–°–∫–æ—Ä–æ –∏–≤–µ–Ω—Ç';
  }

  // ====== –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ======
  let last=performance.now();
  function loop(now){
    const dt=(now-last)/1000; last=now;
    state.score += currentCPS()*dt;
    if(Math.random()<0.004){
      const lines=['¬´–ö–∞–∂–¥–∞—è –ø–µ—á–∞—Ç—å ‚Äî —à–∞–≥ –∫ –ø–æ—Ä—è–¥–∫—É!¬ª','¬´–û—Å–ª–∏–Ω–∞—è –∫–∞–≤–∞–ª–µ—Ä–∏—è –ø—Ä–æ—Å–∏—Ç –º–æ—Ä–∫–æ–≤—å-–Ω–∞–¥–±–∞–≤–∫—É¬ª','¬´–®–µ—Ä–∏—Ñ-–≤—É—Ä–¥–∞–ª–∞–∫ –æ—Ñ–æ—Ä–º–∏–ª –Ω–æ—á–Ω–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª¬ª','¬´–ú–µ–¥–∞–ª—å –±–ª–µ—Å—Ç–∏—Ç ‚Äî –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ä–∞—Å—Ç—É—Ç¬ª','¬´–ö–æ–∑–ª–æ–ø–∞—Å—ã –æ–ø—è—Ç—å —É—Ç–∞—â–∏–ª–∏ —Ç–∞–±—É—Ä–µ—Ç¬ª','¬´–ö–æ–≤—á–µ–≥ –ø—Ä–∞–≤–æ—Å—É–¥–∏—è –¥–æ–≤–µ—Ä—Ö—É —É–∫–æ–º–ø–ª–µ–∫—Ç–æ–≤–∞–Ω¬ª'];
      addLog(lines[Math.floor(Math.random()*lines.length)]);
    }
    rollSeasonEvent(now);
    if((Math.floor(now/1000)%2)===0) renderShops();
    updateUIShallow();
    requestAnimationFrame(loop);
  }

  // ====== –°–ª—É—à–∞—Ç–µ–ª–∏ ======
  document.getElementById('clickEmoji').textContent = 'üë®üèø';
  els.target.addEventListener('click', clickGain);
  els.saveBtn.onclick = ()=>{ save(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!') };
  els.wipeBtn.onclick = ()=>{ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')){ localStorage.removeItem('guarma_save_v6'); location.reload(); } };
  els.muteBtn.onclick = ()=>{ state.audioOn=!state.audioOn; els.muteBtn.textContent=state.audioOn?'üîä –ó–≤—É–∫':'üîá –¢–∏—Ö–æ'; if(state.audioOn) ensureAC(); save(); };

  // ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ======
  load(); detectSeason(); scheduleNextSeasonEvent(performance.now()); ensureAC(); updateUI(); requestAnimationFrame(loop);

})();
</script>
</body>
</html>



